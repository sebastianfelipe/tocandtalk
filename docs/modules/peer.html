<!DOCTYPE html>

<html>
<head>
  <title>peer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>peer.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*! peerjs build:0.3.13, development. Copyright(c) 2013 Michelle Bu &lt;michelle@michellebu.com&gt; */</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">e</span>(<span class="hljs-params">t,n,r</span>)</span>{<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s</span>(<span class="hljs-params">o,u</span>)</span>{<span class="hljs-keyword">if</span>(!n[o]){<span class="hljs-keyword">if</span>(!t[o]){<span class="hljs-keyword">var</span> a=<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span>==<span class="hljs-string">"function"</span>&amp;&amp;<span class="hljs-built_in">require</span>;<span class="hljs-keyword">if</span>(!u&amp;&amp;a)<span class="hljs-keyword">return</span> a(o,!<span class="hljs-number">0</span>);<span class="hljs-keyword">if</span>(i)<span class="hljs-keyword">return</span> i(o,!<span class="hljs-number">0</span>);<span class="hljs-keyword">var</span> f=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find module '"</span>+o+<span class="hljs-string">"'"</span>);<span class="hljs-keyword">throw</span> f.code=<span class="hljs-string">"MODULE_NOT_FOUND"</span>,f}<span class="hljs-keyword">var</span> l=n[o]={exports:{}};t[o][<span class="hljs-number">0</span>].call(l.exports,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>)</span>{<span class="hljs-keyword">var</span> n=t[o][<span class="hljs-number">1</span>][e];<span class="hljs-keyword">return</span> s(n?n:e)},l,l.exports,e,t,n,r)}<span class="hljs-keyword">return</span> n[o].exports}<span class="hljs-keyword">var</span> i=<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span>==<span class="hljs-string">"function"</span>&amp;&amp;<span class="hljs-built_in">require</span>;<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> o=<span class="hljs-number">0</span>;o&lt;r.length;o++)s(r[o]);<span class="hljs-keyword">return</span> s})({<span class="hljs-number">1</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-built_in">module</span>.exports.RTCSessionDescription = <span class="hljs-built_in">window</span>.RTCSessionDescription ||
	<span class="hljs-built_in">window</span>.mozRTCSessionDescription;
<span class="hljs-built_in">module</span>.exports.RTCPeerConnection = <span class="hljs-built_in">window</span>.RTCPeerConnection ||
	<span class="hljs-built_in">window</span>.mozRTCPeerConnection || <span class="hljs-built_in">window</span>.webkitRTCPeerConnection;
<span class="hljs-built_in">module</span>.exports.RTCIceCandidate = <span class="hljs-built_in">window</span>.RTCIceCandidate ||
	<span class="hljs-built_in">window</span>.mozRTCIceCandidate;

},{}],<span class="hljs-number">2</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eventemitter3'</span>);
<span class="hljs-keyword">var</span> Negotiator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./negotiator'</span>);
<span class="hljs-keyword">var</span> Reliable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'reliable'</span>);

<span class="hljs-comment">/**
 * Wraps a DataChannel between two Peers.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DataConnection</span>(<span class="hljs-params">peer, provider, options</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> DataConnection)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataConnection(peer, provider, options);
  EventEmitter.call(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>.options = util.extend({
    serialization: <span class="hljs-string">'binary'</span>,
    reliable: <span class="hljs-literal">false</span>
  }, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Connection is not open yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.type = <span class="hljs-string">'data'</span>;
  <span class="hljs-keyword">this</span>.peer = peer;
  <span class="hljs-keyword">this</span>.provider = provider;

  <span class="hljs-keyword">this</span>.id = <span class="hljs-keyword">this</span>.options.connectionId || DataConnection._idPrefix + util.randomToken();

  <span class="hljs-keyword">this</span>.label = <span class="hljs-keyword">this</span>.options.label || <span class="hljs-keyword">this</span>.id;
  <span class="hljs-keyword">this</span>.metadata = <span class="hljs-keyword">this</span>.options.metadata;
  <span class="hljs-keyword">this</span>.serialization = <span class="hljs-keyword">this</span>.options.serialization;
  <span class="hljs-keyword">this</span>.reliable = <span class="hljs-keyword">this</span>.options.reliable;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Data channel buffering.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._buffer = [];
  <span class="hljs-keyword">this</span>._buffering = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.bufferSize = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>For storing large data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._chunkedData = {};

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.options._payload) {
    <span class="hljs-keyword">this</span>._peerBrowser = <span class="hljs-keyword">this</span>.options._payload.browser;
  }

  Negotiator.startConnection(
    <span class="hljs-keyword">this</span>,
    <span class="hljs-keyword">this</span>.options._payload || {
      originator: <span class="hljs-literal">true</span>
    }
  );
}

util.inherits(DataConnection, EventEmitter);

DataConnection._idPrefix = <span class="hljs-string">'dc_'</span>;

<span class="hljs-comment">/** Called by the Negotiator when the DataChannel is ready. */</span>
DataConnection.prototype.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dc</span>) </span>{
  <span class="hljs-keyword">this</span>._dc = <span class="hljs-keyword">this</span>.dataChannel = dc;
  <span class="hljs-keyword">this</span>._configureDataChannel();
}

DataConnection.prototype._configureDataChannel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">if</span> (util.supports.sctp) {
    <span class="hljs-keyword">this</span>._dc.binaryType = <span class="hljs-string">'arraybuffer'</span>;
  }
  <span class="hljs-keyword">this</span>._dc.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    util.log(<span class="hljs-string">'Data channel connection success'</span>);
    self.open = <span class="hljs-literal">true</span>;
    self.emit(<span class="hljs-string">'open'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Use the Reliable shim for non Firefox browsers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!util.supports.sctp &amp;&amp; <span class="hljs-keyword">this</span>.reliable) {
    <span class="hljs-keyword">this</span>._reliable = <span class="hljs-keyword">new</span> Reliable(<span class="hljs-keyword">this</span>._dc, util.debug);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._reliable) {
    <span class="hljs-keyword">this</span>._reliable.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
      self.emit(<span class="hljs-string">'data'</span>, msg);
    };
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._dc.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
      self._handleDataMessage(e);
    };
  }
  <span class="hljs-keyword">this</span>._dc.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    util.log(<span class="hljs-string">'DataChannel closed for:'</span>, self.peer);
    self.close();
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Handles a DataChannel message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>DataConnection.prototype._handleDataMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> data = e.data;
  <span class="hljs-keyword">var</span> datatype = data.constructor;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.serialization === <span class="hljs-string">'binary'</span> || <span class="hljs-keyword">this</span>.serialization === <span class="hljs-string">'binary-utf8'</span>) {
    <span class="hljs-keyword">if</span> (datatype === Blob) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Datatype should never be blob</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      util.blobToArrayBuffer(data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ab</span>) </span>{
        data = util.unpack(ab);
        self.emit(<span class="hljs-string">'data'</span>, data);
      });
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (datatype === <span class="hljs-built_in">ArrayBuffer</span>) {
      data = util.unpack(data);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (datatype === <span class="hljs-built_in">String</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>String fallback for binary data for browsers that don’t support binary yet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> ab = util.binaryStringToArrayBuffer(data);
      data = util.unpack(ab);
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.serialization === <span class="hljs-string">'json'</span>) {
    data = <span class="hljs-built_in">JSON</span>.parse(data);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Check if we’ve chunked–if so, piece things back together.
We’re guaranteed that this isn’t 0.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (data.__peerData) {
    <span class="hljs-keyword">var</span> id = data.__peerData;
    <span class="hljs-keyword">var</span> chunkInfo = <span class="hljs-keyword">this</span>._chunkedData[id] || {data: [], count: <span class="hljs-number">0</span>, total: data.total};

    chunkInfo.data[data.n] = data.data;
    chunkInfo.count += <span class="hljs-number">1</span>;

    <span class="hljs-keyword">if</span> (chunkInfo.total === chunkInfo.count) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Clean up before making the recursive call to <code>_handleDataMessage</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._chunkedData[id];</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>We’ve received all the chunks–time to construct the complete data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      data = <span class="hljs-keyword">new</span> Blob(chunkInfo.data);
      <span class="hljs-keyword">this</span>._handleDataMessage({data: data});
    }

    <span class="hljs-keyword">this</span>._chunkedData[id] = chunkInfo;
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'data'</span>, data);
}

<span class="hljs-comment">/**
 * Exposed functionality for users.
 */</span>

<span class="hljs-comment">/** Allows user to close connection. */</span>
DataConnection.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.open) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">false</span>;
  Negotiator.cleanup(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'close'</span>);
}

<span class="hljs-comment">/** Allows user to send data. */</span>
DataConnection.prototype.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, chunked</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.open) {
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Connection is not open. You should listen for the `open` event before sending messages.'</span>));
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._reliable) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Note: reliable shim sending will make it so that you cannot customize
serialization.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._reliable.send(data);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.serialization === <span class="hljs-string">'json'</span>) {
    <span class="hljs-keyword">this</span>._bufferedSend(<span class="hljs-built_in">JSON</span>.stringify(data));
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.serialization === <span class="hljs-string">'binary'</span> || <span class="hljs-keyword">this</span>.serialization === <span class="hljs-string">'binary-utf8'</span>) {
    <span class="hljs-keyword">var</span> blob = util.pack(data);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>For Chrome-Firefox interoperability, we need to make Firefox “chunk”
the data it sends out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> needsChunking = util.chunkedBrowsers[<span class="hljs-keyword">this</span>._peerBrowser] || util.chunkedBrowsers[util.browser];
    <span class="hljs-keyword">if</span> (needsChunking &amp;&amp; !chunked &amp;&amp; blob.size &gt; util.chunkedMTU) {
      <span class="hljs-keyword">this</span>._sendChunks(blob);
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>DataChannel currently only supports strings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!util.supports.sctp) {
      util.blobToBinaryString(blob, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{
        self._bufferedSend(str);
      });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!util.supports.binaryBlob) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>We only do this if we really need to (e.g. blobs are not supported),
because this conversion is costly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      util.blobToArrayBuffer(blob, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ab</span>) </span>{
        self._bufferedSend(ab);
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._bufferedSend(blob);
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._bufferedSend(data);
  }
}

DataConnection.prototype._bufferedSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._buffering || !<span class="hljs-keyword">this</span>._trySend(msg)) {
    <span class="hljs-keyword">this</span>._buffer.push(msg);
    <span class="hljs-keyword">this</span>.bufferSize = <span class="hljs-keyword">this</span>._buffer.length;
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Returns true if the send succeeds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>DataConnection.prototype._trySend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">this</span>._dc.send(msg);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">this</span>._buffering = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Try again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self._buffering = <span class="hljs-literal">false</span>;
      self._tryBuffer();
    }, <span class="hljs-number">100</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Try to send the first message in the buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>DataConnection.prototype._tryBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._buffer.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> msg = <span class="hljs-keyword">this</span>._buffer[<span class="hljs-number">0</span>];

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._trySend(msg)) {
    <span class="hljs-keyword">this</span>._buffer.shift();
    <span class="hljs-keyword">this</span>.bufferSize = <span class="hljs-keyword">this</span>._buffer.length;
    <span class="hljs-keyword">this</span>._tryBuffer();
  }
}

DataConnection.prototype._sendChunks = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blob</span>) </span>{
  <span class="hljs-keyword">var</span> blobs = util.chunk(blob);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = blobs.length; i &lt; ii; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">var</span> blob = blobs[i];
    <span class="hljs-keyword">this</span>.send(blob, <span class="hljs-literal">true</span>);
  }
}

DataConnection.prototype.handleMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
  <span class="hljs-keyword">var</span> payload = message.payload;

  <span class="hljs-keyword">switch</span> (message.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ANSWER'</span>:
      <span class="hljs-keyword">this</span>._peerBrowser = payload.browser;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Forward to negotiator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Negotiator.handleSDP(message.type, <span class="hljs-keyword">this</span>, payload.sdp);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'CANDIDATE'</span>:
      Negotiator.handleCandidate(<span class="hljs-keyword">this</span>, payload.candidate);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      util.warn(<span class="hljs-string">'Unrecognized message type:'</span>, message.type, <span class="hljs-string">'from peer:'</span>, <span class="hljs-keyword">this</span>.peer);
      <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-built_in">module</span>.exports = DataConnection;

},{<span class="hljs-string">"./negotiator"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"./util"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"eventemitter3"</span>:<span class="hljs-number">9</span>,<span class="hljs-string">"reliable"</span>:<span class="hljs-number">12</span>}],<span class="hljs-number">3</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-built_in">window</span>.Socket = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./socket'</span>);
<span class="hljs-built_in">window</span>.MediaConnection = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./mediaconnection'</span>);
<span class="hljs-built_in">window</span>.DataConnection = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dataconnection'</span>);
<span class="hljs-built_in">window</span>.Peer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./peer'</span>);
<span class="hljs-built_in">window</span>.RTCPeerConnection = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./adapter'</span>).RTCPeerConnection;
<span class="hljs-built_in">window</span>.RTCSessionDescription = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./adapter'</span>).RTCSessionDescription;
<span class="hljs-built_in">window</span>.RTCIceCandidate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./adapter'</span>).RTCIceCandidate;
<span class="hljs-built_in">window</span>.Negotiator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./negotiator'</span>);
<span class="hljs-built_in">window</span>.util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);
<span class="hljs-built_in">window</span>.BinaryPack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'js-binarypack'</span>);

},{<span class="hljs-string">"./adapter"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"./dataconnection"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"./mediaconnection"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"./negotiator"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"./peer"</span>:<span class="hljs-number">6</span>,<span class="hljs-string">"./socket"</span>:<span class="hljs-number">7</span>,<span class="hljs-string">"./util"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"js-binarypack"</span>:<span class="hljs-number">10</span>}],<span class="hljs-number">4</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eventemitter3'</span>);
<span class="hljs-keyword">var</span> Negotiator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./negotiator'</span>);

<span class="hljs-comment">/**
 * Wraps the streaming interface between two Peers.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MediaConnection</span>(<span class="hljs-params">peer, provider, options</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> MediaConnection)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MediaConnection(peer, provider, options);
  EventEmitter.call(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">this</span>.options = util.extend({}, options);

  <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.type = <span class="hljs-string">'media'</span>;
  <span class="hljs-keyword">this</span>.peer = peer;
  <span class="hljs-keyword">this</span>.provider = provider;
  <span class="hljs-keyword">this</span>.metadata = <span class="hljs-keyword">this</span>.options.metadata;
  <span class="hljs-keyword">this</span>.localStream = <span class="hljs-keyword">this</span>.options._stream;

  <span class="hljs-keyword">this</span>.id = <span class="hljs-keyword">this</span>.options.connectionId || MediaConnection._idPrefix + util.randomToken();
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.localStream) {
    Negotiator.startConnection(
      <span class="hljs-keyword">this</span>,
      {_stream: <span class="hljs-keyword">this</span>.localStream, originator: <span class="hljs-literal">true</span>}
    );
  }
};

util.inherits(MediaConnection, EventEmitter);

MediaConnection._idPrefix = <span class="hljs-string">'mc_'</span>;

MediaConnection.prototype.addStream = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">remoteStream</span>) </span>{
  util.log(<span class="hljs-string">'Receiving stream'</span>, remoteStream);

  <span class="hljs-keyword">this</span>.remoteStream = remoteStream;
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'stream'</span>, remoteStream); <span class="hljs-comment">// Should we call this `open`?</span>

};

MediaConnection.prototype.handleMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
  <span class="hljs-keyword">var</span> payload = message.payload;

  <span class="hljs-keyword">switch</span> (message.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ANSWER'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Forward to negotiator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Negotiator.handleSDP(message.type, <span class="hljs-keyword">this</span>, payload.sdp);
      <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'CANDIDATE'</span>:
      Negotiator.handleCandidate(<span class="hljs-keyword">this</span>, payload.candidate);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      util.warn(<span class="hljs-string">'Unrecognized message type:'</span>, message.type, <span class="hljs-string">'from peer:'</span>, <span class="hljs-keyword">this</span>.peer);
      <span class="hljs-keyword">break</span>;
  }
}

MediaConnection.prototype.answer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stream</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.localStream) {
    util.warn(<span class="hljs-string">'Local stream already exists on this MediaConnection. Are you answering a call twice?'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">this</span>.options._payload._stream = stream;

  <span class="hljs-keyword">this</span>.localStream = stream;
  Negotiator.startConnection(
    <span class="hljs-keyword">this</span>,
    <span class="hljs-keyword">this</span>.options._payload
  )</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Retrieve lost messages stored because PeerConnection not set up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> messages = <span class="hljs-keyword">this</span>.provider._getMessages(<span class="hljs-keyword">this</span>.id);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = messages.length; i &lt; ii; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">this</span>.handleMessage(messages[i]);
  }
  <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">true</span>;
};

<span class="hljs-comment">/**
 * Exposed functionality for users.
 */</span>

<span class="hljs-comment">/** Allows user to close connection. */</span>
MediaConnection.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.open) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">false</span>;
  Negotiator.cleanup(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'close'</span>)
};

<span class="hljs-built_in">module</span>.exports = MediaConnection;

},{<span class="hljs-string">"./negotiator"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"./util"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"eventemitter3"</span>:<span class="hljs-number">9</span>}],<span class="hljs-number">5</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);
<span class="hljs-keyword">var</span> RTCPeerConnection = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./adapter'</span>).RTCPeerConnection;
<span class="hljs-keyword">var</span> RTCSessionDescription = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./adapter'</span>).RTCSessionDescription;
<span class="hljs-keyword">var</span> RTCIceCandidate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./adapter'</span>).RTCIceCandidate;

<span class="hljs-comment">/**
 * Manages all negotiations between Peers.
 */</span>
<span class="hljs-keyword">var</span> Negotiator = {
  pcs: {
    data: {},
    media: {}
  }, <span class="hljs-comment">// type =&gt; {peerId: {pc_id: pc}}.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>providers: {}, // provider’s id =&gt; providers (there may be multiple providers/client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  queue: [] <span class="hljs-comment">// connections that are delayed due to a PC being in use.</span>
}

Negotiator._idPrefix = <span class="hljs-string">'pc_'</span>;

<span class="hljs-comment">/** Returns a PeerConnection object set up correctly (for data, media). */</span>
Negotiator.startConnection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection, options</span>) </span>{
  <span class="hljs-keyword">var</span> pc = Negotiator._getPeerConnection(connection, options);

  <span class="hljs-keyword">if</span> (connection.type === <span class="hljs-string">'media'</span> &amp;&amp; options._stream) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Add the stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pc.addStream(options._stream);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Set the connection’s PC.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  connection.pc = connection.peerConnection = pc;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>What do we need to do now?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.originator) {
    <span class="hljs-keyword">if</span> (connection.type === <span class="hljs-string">'data'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Create the datachannel.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> config = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Dropping reliable:false support, since it seems to be crashing
Chrome.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-comment">/*if (util.supports.sctp &amp;&amp; !options.reliable) {
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>If we have canonical reliable support…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        config = {maxRetransmits: 0};
      }*/</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Fallback to ensure older browsers don’t crash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!util.supports.sctp) {
        config = {reliable: options.reliable};
      }
      <span class="hljs-keyword">var</span> dc = pc.createDataChannel(connection.label, config);
      connection.initialize(dc);
    }

    <span class="hljs-keyword">if</span> (!util.supports.onnegotiationneeded) {
      Negotiator._makeOffer(connection);
    }
  } <span class="hljs-keyword">else</span> {
    Negotiator.handleSDP(<span class="hljs-string">'OFFER'</span>, connection, options.sdp);
  }
}

Negotiator._getPeerConnection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection, options</span>) </span>{
  <span class="hljs-keyword">if</span> (!Negotiator.pcs[connection.type]) {
    util.error(connection.type + <span class="hljs-string">' is not a valid connection type. Maybe you overrode the `type` property somewhere.'</span>);
  }

  <span class="hljs-keyword">if</span> (!Negotiator.pcs[connection.type][connection.peer]) {
    Negotiator.pcs[connection.type][connection.peer] = {};
  }
  <span class="hljs-keyword">var</span> peerConnections = Negotiator.pcs[connection.type][connection.peer];

  <span class="hljs-keyword">var</span> pc;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Not multiplexing while FF and Chrome have not-great support for it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-comment">/*if (options.multiplex) {
    ids = Object.keys(peerConnections);
    for (var i = 0, ii = ids.length; i &lt; ii; i += 1) {
      pc = peerConnections[ids[i]];
      if (pc.signalingState === 'stable') {
        break; // We can go ahead and use this PC.
      }
    }
  } else */</span>
  <span class="hljs-keyword">if</span> (options.pc) { <span class="hljs-comment">// Simplest case: PC id already provided for us.</span>
    pc = Negotiator.pcs[connection.type][connection.peer][options.pc];
  }

  <span class="hljs-keyword">if</span> (!pc || pc.signalingState !== <span class="hljs-string">'stable'</span>) {
    pc = Negotiator._startPeerConnection(connection);
  }
  <span class="hljs-keyword">return</span> pc;
}

<span class="hljs-comment">/*
Negotiator._addProvider = function(provider) {
  if ((!provider.id &amp;&amp; !provider.disconnected) || !provider.socket.open) {
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Wait for provider to obtain an ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    provider.on('open', function(id) {
      Negotiator._addProvider(provider);
    });
  } else {
    Negotiator.providers[provider.id] = provider;
  }
}*/


/** Start a PC. */
Negotiator._startPeerConnection = function(connection) {
  util.log('Creating RTCPeerConnection.');

  var id = Negotiator._idPrefix + util.randomToken();
  var optional = {};

  if (connection.type === 'data' &amp;&amp; !util.supports.sctp) {
    optional = {optional: [{RtpDataChannels: true}]};
  } else if (connection.type === 'media') {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Interop req for chrome.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    optional = {optional: [{DtlsSrtpKeyAgreement: <span class="hljs-literal">true</span>}]};
  }

  <span class="hljs-keyword">var</span> pc = <span class="hljs-keyword">new</span> RTCPeerConnection(connection.provider.options.config, optional);
  Negotiator.pcs[connection.type][connection.peer][id] = pc;

  Negotiator._setupListeners(connection, pc, id);

  <span class="hljs-keyword">return</span> pc;
}

<span class="hljs-comment">/** Set up various WebRTC listeners. */</span>
Negotiator._setupListeners = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection, pc, pc_id</span>) </span>{
  <span class="hljs-keyword">var</span> peerId = connection.peer;
  <span class="hljs-keyword">var</span> connectionId = connection.id;
  <span class="hljs-keyword">var</span> provider = connection.provider;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>ICE CANDIDATES.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  util.log(<span class="hljs-string">'Listening for ICE candidates.'</span>);
  pc.onicecandidate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
    <span class="hljs-keyword">if</span> (evt.candidate) {
      util.log(<span class="hljs-string">'Received ICE candidates for:'</span>, connection.peer);
      provider.socket.send({
        type: <span class="hljs-string">'CANDIDATE'</span>,
        payload: {
          candidate: evt.candidate,
          type: connection.type,
          connectionId: connection.id
        },
        dst: peerId
      });
    }
  };

  pc.oniceconnectionstatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">switch</span> (pc.iceConnectionState) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'disconnected'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'failed'</span>:
        util.log(<span class="hljs-string">'iceConnectionState is disconnected, closing connections to '</span> + peerId);
        connection.close();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'completed'</span>:
        pc.onicecandidate = util.noop;
        <span class="hljs-keyword">break</span>;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Fallback for older Chrome impls.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pc.onicechange = pc.oniceconnectionstatechange;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>ONNEGOTIATIONNEEDED (Chrome)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  util.log(<span class="hljs-string">'Listening for `negotiationneeded`'</span>);
  pc.onnegotiationneeded = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    util.log(<span class="hljs-string">'`negotiationneeded` triggered'</span>);
    <span class="hljs-keyword">if</span> (pc.signalingState == <span class="hljs-string">'stable'</span>) {
      Negotiator._makeOffer(connection);
    } <span class="hljs-keyword">else</span> {
      util.log(<span class="hljs-string">'onnegotiationneeded triggered when not stable. Is another connection being established?'</span>);
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>DATACONNECTION.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  util.log(<span class="hljs-string">'Listening for data channel'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Fired between offer and answer, so options should already be saved
in the options hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pc.ondatachannel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
    util.log(<span class="hljs-string">'Received data channel'</span>);
    <span class="hljs-keyword">var</span> dc = evt.channel;
    <span class="hljs-keyword">var</span> connection = provider.getConnection(peerId, connectionId);
    connection.initialize(dc);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>MEDIACONNECTION.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  util.log(<span class="hljs-string">'Listening for remote stream'</span>);
  pc.onaddstream = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
    util.log(<span class="hljs-string">'Received remote stream'</span>);
    <span class="hljs-keyword">var</span> stream = evt.stream;
    <span class="hljs-keyword">var</span> connection = provider.getConnection(peerId, connectionId);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>10/10/2014: looks like in Chrome 38, onaddstream is triggered after
setting the remote description. Our connection object in these cases
is actually a DATA connection, so addStream fails.
TODO: This is hopefully just a temporary fix. We should try to
understand why this is happening.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (connection.type === <span class="hljs-string">'media'</span>) {
      connection.addStream(stream);
    }
  };
}

Negotiator.cleanup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection</span>) </span>{
  util.log(<span class="hljs-string">'Cleaning up PeerConnection to '</span> + connection.peer);

  <span class="hljs-keyword">var</span> pc = connection.pc;

  <span class="hljs-keyword">if</span> (!!pc &amp;&amp; (pc.readyState !== <span class="hljs-string">'closed'</span> || pc.signalingState !== <span class="hljs-string">'closed'</span>)) {
    pc.close();
    connection.pc = <span class="hljs-literal">null</span>;
  }
}

Negotiator._makeOffer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection</span>) </span>{
  <span class="hljs-keyword">var</span> pc = connection.pc;
  pc.createOffer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">offer</span>) </span>{
    util.log(<span class="hljs-string">'Created offer.'</span>);

    <span class="hljs-keyword">if</span> (!util.supports.sctp &amp;&amp; connection.type === <span class="hljs-string">'data'</span> &amp;&amp; connection.reliable) {
      offer.sdp = Reliable.higherBandwidthSDP(offer.sdp);
    }

    pc.setLocalDescription(offer, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      util.log(<span class="hljs-string">'Set localDescription: offer'</span>, <span class="hljs-string">'for:'</span>, connection.peer);
      connection.provider.socket.send({
        type: <span class="hljs-string">'OFFER'</span>,
        payload: {
          sdp: offer,
          type: connection.type,
          label: connection.label,
          connectionId: connection.id,
          reliable: connection.reliable,
          serialization: connection.serialization,
          metadata: connection.metadata,
          browser: util.browser
        },
        dst: connection.peer
      });
    }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      connection.provider.emitError(<span class="hljs-string">'webrtc'</span>, err);
      util.log(<span class="hljs-string">'Failed to setLocalDescription, '</span>, err);
    });
  }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    connection.provider.emitError(<span class="hljs-string">'webrtc'</span>, err);
    util.log(<span class="hljs-string">'Failed to createOffer, '</span>, err);
  }, connection.options.constraints);
}

Negotiator._makeAnswer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection</span>) </span>{
  <span class="hljs-keyword">var</span> pc = connection.pc;

  pc.createAnswer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">answer</span>) </span>{
    util.log(<span class="hljs-string">'Created answer.'</span>);

    <span class="hljs-keyword">if</span> (!util.supports.sctp &amp;&amp; connection.type === <span class="hljs-string">'data'</span> &amp;&amp; connection.reliable) {
      answer.sdp = Reliable.higherBandwidthSDP(answer.sdp);
    }

    pc.setLocalDescription(answer, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      util.log(<span class="hljs-string">'Set localDescription: answer'</span>, <span class="hljs-string">'for:'</span>, connection.peer);
      connection.provider.socket.send({
        type: <span class="hljs-string">'ANSWER'</span>,
        payload: {
          sdp: answer,
          type: connection.type,
          connectionId: connection.id,
          browser: util.browser
        },
        dst: connection.peer
      });
    }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      connection.provider.emitError(<span class="hljs-string">'webrtc'</span>, err);
      util.log(<span class="hljs-string">'Failed to setLocalDescription, '</span>, err);
    });
  }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    connection.provider.emitError(<span class="hljs-string">'webrtc'</span>, err);
    util.log(<span class="hljs-string">'Failed to create answer, '</span>, err);
  });
}

<span class="hljs-comment">/** Handle an SDP. */</span>
Negotiator.handleSDP = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, connection, sdp</span>) </span>{
  sdp = <span class="hljs-keyword">new</span> RTCSessionDescription(sdp);
  <span class="hljs-keyword">var</span> pc = connection.pc;

  util.log(<span class="hljs-string">'Setting remote description'</span>, sdp);
  pc.setRemoteDescription(sdp, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    util.log(<span class="hljs-string">'Set remoteDescription:'</span>, type, <span class="hljs-string">'for:'</span>, connection.peer);

    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'OFFER'</span>) {
      Negotiator._makeAnswer(connection);
    }
  }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    connection.provider.emitError(<span class="hljs-string">'webrtc'</span>, err);
    util.log(<span class="hljs-string">'Failed to setRemoteDescription, '</span>, err);
  });
}

<span class="hljs-comment">/** Handle a candidate. */</span>
Negotiator.handleCandidate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection, ice</span>) </span>{
  <span class="hljs-keyword">var</span> candidate = ice.candidate;
  <span class="hljs-keyword">var</span> sdpMLineIndex = ice.sdpMLineIndex;
  connection.pc.addIceCandidate(<span class="hljs-keyword">new</span> RTCIceCandidate({
    sdpMLineIndex: sdpMLineIndex,
    candidate: candidate
  }));
  util.log(<span class="hljs-string">'Added ICE candidate for:'</span>, connection.peer);
}

<span class="hljs-built_in">module</span>.exports = Negotiator;

},{<span class="hljs-string">"./adapter"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"./util"</span>:<span class="hljs-number">8</span>}],<span class="hljs-number">6</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eventemitter3'</span>);
<span class="hljs-keyword">var</span> Socket = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./socket'</span>);
<span class="hljs-keyword">var</span> MediaConnection = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./mediaconnection'</span>);
<span class="hljs-keyword">var</span> DataConnection = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dataconnection'</span>);

<span class="hljs-comment">/**
 * A peer who can initiate connections with other peers.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Peer</span>(<span class="hljs-params">id, options</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Peer)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Peer(id, options);
  EventEmitter.call(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Deal with overloading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (id &amp;&amp; id.constructor == <span class="hljs-built_in">Object</span>) {
    options = id;
    id = <span class="hljs-literal">undefined</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (id) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Ensure id is a string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    id = id.toString();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Configurize options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options = util.extend({
    debug: <span class="hljs-number">0</span>, <span class="hljs-comment">// 1: Errors, 2: Warnings, 3: All logs</span>
    host: util.CLOUD_HOST,
    port: util.CLOUD_PORT,
    key: <span class="hljs-string">'peerjs'</span>,
    path: <span class="hljs-string">'/'</span>,
    token: util.randomToken(),
    config: util.defaultConfig
  }, options);
  <span class="hljs-keyword">this</span>.options = options;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Detect relative URL host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.host === <span class="hljs-string">'/'</span>) {
    options.host = <span class="hljs-built_in">window</span>.location.hostname;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Set path correctly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.path[<span class="hljs-number">0</span>] !== <span class="hljs-string">'/'</span>) {
    options.path = <span class="hljs-string">'/'</span> + options.path;
  }
  <span class="hljs-keyword">if</span> (options.path[options.path.length - <span class="hljs-number">1</span>] !== <span class="hljs-string">'/'</span>) {
    options.path += <span class="hljs-string">'/'</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Set whether we use SSL to same as current host</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.secure === <span class="hljs-literal">undefined</span> &amp;&amp; options.host !== util.CLOUD_HOST) {
    options.secure = util.isSecure();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Set a custom log function if present</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.logFunction) {
    util.setLogFunction(options.logFunction);
  }
  util.setLogLevel(options.debug);</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Sanity checks
Ensure WebRTC supported</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!util.supports.audioVideo &amp;&amp; !util.supports.data ) {
    <span class="hljs-keyword">this</span>._delayedAbort(<span class="hljs-string">'browser-incompatible'</span>, <span class="hljs-string">'The current browser does not support WebRTC'</span>);
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Ensure alphanumeric id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!util.validateId(id)) {
    <span class="hljs-keyword">this</span>._delayedAbort(<span class="hljs-string">'invalid-id'</span>, <span class="hljs-string">'ID "'</span> + id + <span class="hljs-string">'" is invalid'</span>);
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Ensure valid key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!util.validateKey(options.key)) {
    <span class="hljs-keyword">this</span>._delayedAbort(<span class="hljs-string">'invalid-key'</span>, <span class="hljs-string">'API KEY "'</span> + options.key + <span class="hljs-string">'" is invalid'</span>);
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Ensure not using unsecure cloud server on SSL page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.secure &amp;&amp; options.host === <span class="hljs-string">'0.peerjs.com'</span>) {
    <span class="hljs-keyword">this</span>._delayedAbort(<span class="hljs-string">'ssl-unavailable'</span>,
      <span class="hljs-string">'The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS.'</span>);
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>States.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.destroyed = <span class="hljs-literal">false</span>; <span class="hljs-comment">// Connections have been killed</span>
  <span class="hljs-keyword">this</span>.disconnected = <span class="hljs-literal">false</span>; <span class="hljs-comment">// Connection to PeerServer killed but P2P connections still active</span>
  <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">false</span>; <span class="hljs-comment">// Sockets and such are not yet open.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>References</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.connections = {}; <span class="hljs-comment">// DataConnections for this peer.</span>
  <span class="hljs-keyword">this</span>._lostMessages = {}; <span class="hljs-comment">// src =&gt; [list of messages]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Start the server connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._initializeServerConnection();
  <span class="hljs-keyword">if</span> (id) {
    <span class="hljs-keyword">this</span>._initialize(id);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>._retrieveId();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>}

util.inherits(Peer, EventEmitter);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Initialize the ‘socket’ (which is actually a mix of XHR streaming and
websockets.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Peer.prototype._initializeServerConnection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.socket = <span class="hljs-keyword">new</span> Socket(<span class="hljs-keyword">this</span>.options.secure, <span class="hljs-keyword">this</span>.options.host, <span class="hljs-keyword">this</span>.options.port, <span class="hljs-keyword">this</span>.options.path, <span class="hljs-keyword">this</span>.options.key);
  <span class="hljs-keyword">this</span>.socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
    self._handleMessage(data);
  });
  <span class="hljs-keyword">this</span>.socket.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
    self._abort(<span class="hljs-string">'socket-error'</span>, error);
  });
  <span class="hljs-keyword">this</span>.socket.on(<span class="hljs-string">'disconnected'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>If we haven’t explicitly disconnected, emit error and disconnect.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!self.disconnected) {
      self.emitError(<span class="hljs-string">'network'</span>, <span class="hljs-string">'Lost connection to server.'</span>);
      self.disconnect();
    }
  });
  <span class="hljs-keyword">this</span>.socket.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>If we haven’t explicitly disconnected, emit error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!self.disconnected) {
      self._abort(<span class="hljs-string">'socket-closed'</span>, <span class="hljs-string">'Underlying socket is already closed.'</span>);
    }
  });
};

<span class="hljs-comment">/** Get a unique ID from the server via XHR. */</span>
Peer.prototype._retrieveId = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> http = <span class="hljs-keyword">new</span> XMLHttpRequest();
  <span class="hljs-keyword">var</span> protocol = <span class="hljs-keyword">this</span>.options.secure ? <span class="hljs-string">'https://'</span> : <span class="hljs-string">'http://'</span>;
  <span class="hljs-keyword">var</span> url = protocol + <span class="hljs-keyword">this</span>.options.host + <span class="hljs-string">':'</span> + <span class="hljs-keyword">this</span>.options.port +
    <span class="hljs-keyword">this</span>.options.path + <span class="hljs-keyword">this</span>.options.key + <span class="hljs-string">'/id'</span>;
  <span class="hljs-keyword">var</span> queryString = <span class="hljs-string">'?ts='</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() + <span class="hljs-string">''</span> + <span class="hljs-built_in">Math</span>.random();
  url += queryString;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>If there’s no ID we need to wait for one before trying to init socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  http.open(<span class="hljs-string">'get'</span>, url, <span class="hljs-literal">true</span>);
  http.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    util.error(<span class="hljs-string">'Error retrieving ID'</span>, e);
    <span class="hljs-keyword">var</span> pathError = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (self.options.path === <span class="hljs-string">'/'</span> &amp;&amp; self.options.host !== util.CLOUD_HOST) {
      pathError = <span class="hljs-string">' If you passed in a `path` to your self-hosted PeerServer, '</span> +
        <span class="hljs-string">'you\'ll also need to pass in that same path when creating a new '</span> +
        <span class="hljs-string">'Peer.'</span>;
    }
    self._abort(<span class="hljs-string">'server-error'</span>, <span class="hljs-string">'Could not get an ID from the server.'</span> + pathError);
  };
  http.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (http.readyState !== <span class="hljs-number">4</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (http.status !== <span class="hljs-number">200</span>) {
      http.onerror();
      <span class="hljs-keyword">return</span>;
    }
    self._initialize(http.responseText);
  };
  http.send(<span class="hljs-literal">null</span>);
};

<span class="hljs-comment">/** Initialize a connection with the server. */</span>
Peer.prototype._initialize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">this</span>.id = id;
  <span class="hljs-keyword">this</span>.socket.start(<span class="hljs-keyword">this</span>.id, <span class="hljs-keyword">this</span>.options.token);
};

<span class="hljs-comment">/** Handles messages from the server. */</span>
Peer.prototype._handleMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
  <span class="hljs-keyword">var</span> type = message.type;
  <span class="hljs-keyword">var</span> payload = message.payload;
  <span class="hljs-keyword">var</span> peer = message.src;
  <span class="hljs-keyword">var</span> connection;

  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'OPEN'</span>: <span class="hljs-comment">// The connection to the server is open.</span>
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'open'</span>, <span class="hljs-keyword">this</span>.id);
      <span class="hljs-keyword">this</span>.open = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ERROR'</span>: <span class="hljs-comment">// Server error.</span>
      <span class="hljs-keyword">this</span>._abort(<span class="hljs-string">'server-error'</span>, payload.msg);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ID-TAKEN'</span>: <span class="hljs-comment">// The selected ID is taken.</span>
      <span class="hljs-keyword">this</span>._abort(<span class="hljs-string">'unavailable-id'</span>, <span class="hljs-string">'ID `'</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">'` is taken'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'INVALID-KEY'</span>: <span class="hljs-comment">// The given API key cannot be found.</span>
      <span class="hljs-keyword">this</span>._abort(<span class="hljs-string">'invalid-key'</span>, <span class="hljs-string">'API KEY "'</span> + <span class="hljs-keyword">this</span>.options.key + <span class="hljs-string">'" is invalid'</span>);
      <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">case</span> <span class="hljs-string">'LEAVE'</span>: <span class="hljs-comment">// Another peer has closed its connection to this peer.</span>
      util.log(<span class="hljs-string">'Received leave message from'</span>, peer);
      <span class="hljs-keyword">this</span>._cleanupPeer(peer);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'EXPIRE'</span>: <span class="hljs-comment">// The offer sent to a peer has expired without response.</span>
      <span class="hljs-keyword">this</span>.emitError(<span class="hljs-string">'peer-unavailable'</span>, <span class="hljs-string">'Could not connect to peer '</span> + peer);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'OFFER'</span>: <span class="hljs-comment">// we should consider switching this to CALL/CONNECT, but this is the least breaking option.</span>
      <span class="hljs-keyword">var</span> connectionId = payload.connectionId;
      connection = <span class="hljs-keyword">this</span>.getConnection(peer, connectionId);

      <span class="hljs-keyword">if</span> (connection) {
        util.warn(<span class="hljs-string">'Offer received for existing Connection ID:'</span>, connectionId);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>connection.handleMessage(message);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Create a new connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (payload.type === <span class="hljs-string">'media'</span>) {
          connection = <span class="hljs-keyword">new</span> MediaConnection(peer, <span class="hljs-keyword">this</span>, {
            connectionId: connectionId,
            _payload: payload,
            metadata: payload.metadata
          });
          <span class="hljs-keyword">this</span>._addConnection(peer, connection);
          <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'call'</span>, connection);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (payload.type === <span class="hljs-string">'data'</span>) {
          connection = <span class="hljs-keyword">new</span> DataConnection(peer, <span class="hljs-keyword">this</span>, {
            connectionId: connectionId,
            _payload: payload,
            metadata: payload.metadata,
            label: payload.label,
            serialization: payload.serialization,
            reliable: payload.reliable
          });
          <span class="hljs-keyword">this</span>._addConnection(peer, connection);
          <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'connection'</span>, connection);
        } <span class="hljs-keyword">else</span> {
          util.warn(<span class="hljs-string">'Received malformed connection type:'</span>, payload.type);
          <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Find messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> messages = <span class="hljs-keyword">this</span>._getMessages(connectionId);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = messages.length; i &lt; ii; i += <span class="hljs-number">1</span>) {
          connection.handleMessage(messages[i]);
        }
      }
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">if</span> (!payload) {
        util.warn(<span class="hljs-string">'You received a malformed message from '</span> + peer + <span class="hljs-string">' of type '</span> + type);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">var</span> id = payload.connectionId;
      connection = <span class="hljs-keyword">this</span>.getConnection(peer, id);

      <span class="hljs-keyword">if</span> (connection &amp;&amp; connection.pc) {</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Pass it on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        connection.handleMessage(message);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (id) {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Store for possible later use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._storeMessage(id, message);
      } <span class="hljs-keyword">else</span> {
        util.warn(<span class="hljs-string">'You received an unrecognized message:'</span>, message);
      }
      <span class="hljs-keyword">break</span>;
  }
};

<span class="hljs-comment">/** Stores messages without a set up connection, to be claimed later. */</span>
Peer.prototype._storeMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connectionId, message</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._lostMessages[connectionId]) {
    <span class="hljs-keyword">this</span>._lostMessages[connectionId] = [];
  }
  <span class="hljs-keyword">this</span>._lostMessages[connectionId].push(message);
};

<span class="hljs-comment">/** Retrieve messages from lost message store */</span>
Peer.prototype._getMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connectionId</span>) </span>{
  <span class="hljs-keyword">var</span> messages = <span class="hljs-keyword">this</span>._lostMessages[connectionId];
  <span class="hljs-keyword">if</span> (messages) {
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._lostMessages[connectionId];
    <span class="hljs-keyword">return</span> messages;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> [];
  }
};

<span class="hljs-comment">/**
 * Returns a DataConnection to the specified peer. See documentation for a
 * complete list of options.
 */</span>
Peer.prototype.connect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">peer, options</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.disconnected) {
    util.warn(<span class="hljs-string">'You cannot connect to a new Peer because you called '</span> +
      <span class="hljs-string">'.disconnect() on this Peer and ended your connection with the '</span> +
      <span class="hljs-string">'server. You can create a new Peer to reconnect, or call reconnect '</span> +
      <span class="hljs-string">'on this peer if you believe its ID to still be available.'</span>);
    <span class="hljs-keyword">this</span>.emitError(<span class="hljs-string">'disconnected'</span>, <span class="hljs-string">'Cannot connect to new Peer after disconnecting from server.'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">new</span> DataConnection(peer, <span class="hljs-keyword">this</span>, options);
  <span class="hljs-keyword">this</span>._addConnection(peer, connection);
  <span class="hljs-keyword">return</span> connection;
};

<span class="hljs-comment">/**
 * Returns a MediaConnection to the specified peer. See documentation for a
 * complete list of options.
 */</span>
Peer.prototype.call = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">peer, stream, options</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.disconnected) {
    util.warn(<span class="hljs-string">'You cannot connect to a new Peer because you called '</span> +
      <span class="hljs-string">'.disconnect() on this Peer and ended your connection with the '</span> +
      <span class="hljs-string">'server. You can create a new Peer to reconnect.'</span>);
    <span class="hljs-keyword">this</span>.emitError(<span class="hljs-string">'disconnected'</span>, <span class="hljs-string">'Cannot connect to new Peer after disconnecting from server.'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (!stream) {
    util.error(<span class="hljs-string">'To call a peer, you must provide a stream from your browser\'s `getUserMedia`.'</span>);
    <span class="hljs-keyword">return</span>;
  }
  options = options || {};
  options._stream = stream;
  <span class="hljs-keyword">var</span> call = <span class="hljs-keyword">new</span> MediaConnection(peer, <span class="hljs-keyword">this</span>, options);
  <span class="hljs-keyword">this</span>._addConnection(peer, call);
  <span class="hljs-keyword">return</span> call;
};

<span class="hljs-comment">/** Add a data/media connection to this peer. */</span>
Peer.prototype._addConnection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">peer, connection</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.connections[peer]) {
    <span class="hljs-keyword">this</span>.connections[peer] = [];
  }
  <span class="hljs-keyword">this</span>.connections[peer].push(connection);
};

<span class="hljs-comment">/** Retrieve a data/media connection for this peer. */</span>
Peer.prototype.getConnection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">peer, id</span>) </span>{
  <span class="hljs-keyword">var</span> connections = <span class="hljs-keyword">this</span>.connections[peer];
  <span class="hljs-keyword">if</span> (!connections) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = connections.length; i &lt; ii; i++) {
    <span class="hljs-keyword">if</span> (connections[i].id === id) {
      <span class="hljs-keyword">return</span> connections[i];
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

Peer.prototype._delayedAbort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, message</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  util.setZeroTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    self._abort(type, message);
  });
};

<span class="hljs-comment">/**
 * Destroys the Peer and emits an error message.
 * The Peer is not destroyed if it's in a disconnected state, in which case
 * it retains its disconnected state and its existing connections.
 */</span>
Peer.prototype._abort = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, message</span>) </span>{
  util.error(<span class="hljs-string">'Aborting!'</span>);
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._lastServerId) {
    <span class="hljs-keyword">this</span>.destroy();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.disconnect();
  }
  <span class="hljs-keyword">this</span>.emitError(type, message);
};

<span class="hljs-comment">/** Emits a typed error message. */</span>
Peer.prototype.emitError = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, err</span>) </span>{
  util.error(<span class="hljs-string">'Error:'</span>, err);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> err === <span class="hljs-string">'string'</span>) {
    err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err);
  }
  err.type = type;
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, err);
};

<span class="hljs-comment">/**
 * Destroys the Peer: closes all active connections as well as the connection
 *  to the server.
 * Warning: The peer can no longer create or accept connections after being
 *  destroyed.
 */</span>
Peer.prototype.destroy = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.destroyed) {
    <span class="hljs-keyword">this</span>._cleanup();
    <span class="hljs-keyword">this</span>.disconnect();
    <span class="hljs-keyword">this</span>.destroyed = <span class="hljs-literal">true</span>;
  }
};


<span class="hljs-comment">/** Disconnects every connection on this peer. */</span>
Peer.prototype._cleanup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connections) {
    <span class="hljs-keyword">var</span> peers = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.connections);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = peers.length; i &lt; ii; i++) {
      <span class="hljs-keyword">this</span>._cleanupPeer(peers[i]);
    }
  }
  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'close'</span>);
};

<span class="hljs-comment">/** Closes all connections to this peer. */</span>
Peer.prototype._cleanupPeer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">peer</span>) </span>{
  <span class="hljs-keyword">var</span> connections = <span class="hljs-keyword">this</span>.connections[peer];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>, jj = connections.length; j &lt; jj; j += <span class="hljs-number">1</span>) {
    connections[j].close();
  }
};

<span class="hljs-comment">/**
 * Disconnects the Peer's connection to the PeerServer. Does not close any
 *  active connections.
 * Warning: The peer can no longer create or accept connections after being
 *  disconnected. It also cannot reconnect to the server.
 */</span>
Peer.prototype.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  util.setZeroTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span> (!self.disconnected) {
      self.disconnected = <span class="hljs-literal">true</span>;
      self.open = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (self.socket) {
        self.socket.close();
      }
      self.emit(<span class="hljs-string">'disconnected'</span>, self.id);
      self._lastServerId = self.id;
      self.id = <span class="hljs-literal">null</span>;
    }
  });
};

<span class="hljs-comment">/** Attempts to reconnect with the same ID. */</span>
Peer.prototype.reconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.disconnected &amp;&amp; !<span class="hljs-keyword">this</span>.destroyed) {
    util.log(<span class="hljs-string">'Attempting reconnection to server with ID '</span> + <span class="hljs-keyword">this</span>._lastServerId);
    <span class="hljs-keyword">this</span>.disconnected = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>._initializeServerConnection();
    <span class="hljs-keyword">this</span>._initialize(<span class="hljs-keyword">this</span>._lastServerId);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.destroyed) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'This peer cannot reconnect to the server. It has already been destroyed.'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.disconnected &amp;&amp; !<span class="hljs-keyword">this</span>.open) {</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Do nothing. We’re still connecting the first time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    util.error(<span class="hljs-string">'In a hurry? We\'re still trying to make the initial connection!'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Peer '</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">' cannot reconnect because it is not disconnected from the server!'</span>);
  }
};

<span class="hljs-comment">/**
 * Get a list of available peer IDs. If you're running your own server, you'll
 * want to set allow_discovery: true in the PeerServer options. If you're using
 * the cloud server, email team@peerjs.com to get the functionality enabled for
 * your key.
 */</span>
Peer.prototype.listAllPeers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
  cb = cb || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> http = <span class="hljs-keyword">new</span> XMLHttpRequest();
  <span class="hljs-keyword">var</span> protocol = <span class="hljs-keyword">this</span>.options.secure ? <span class="hljs-string">'https://'</span> : <span class="hljs-string">'http://'</span>;
  <span class="hljs-keyword">var</span> url = protocol + <span class="hljs-keyword">this</span>.options.host + <span class="hljs-string">':'</span> + <span class="hljs-keyword">this</span>.options.port +
    <span class="hljs-keyword">this</span>.options.path + <span class="hljs-keyword">this</span>.options.key + <span class="hljs-string">'/peers'</span>;
  <span class="hljs-keyword">var</span> queryString = <span class="hljs-string">'?ts='</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() + <span class="hljs-string">''</span> + <span class="hljs-built_in">Math</span>.random();
  url += queryString;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>If there’s no ID we need to wait for one before trying to init socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  http.open(<span class="hljs-string">'get'</span>, url, <span class="hljs-literal">true</span>);
  http.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    self._abort(<span class="hljs-string">'server-error'</span>, <span class="hljs-string">'Could not get peers from the server.'</span>);
    cb([]);
  };
  http.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (http.readyState !== <span class="hljs-number">4</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (http.status === <span class="hljs-number">401</span>) {
      <span class="hljs-keyword">var</span> helpfulError = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">if</span> (self.options.host !== util.CLOUD_HOST) {
        helpfulError = <span class="hljs-string">'It looks like you\'re using the cloud server. You can email '</span> +
          <span class="hljs-string">'team@peerjs.com to enable peer listing for your API key.'</span>;
      } <span class="hljs-keyword">else</span> {
        helpfulError = <span class="hljs-string">'You need to enable `allow_discovery` on your self-hosted '</span> +
          <span class="hljs-string">'PeerServer to use this feature.'</span>;
      }
      cb([]);
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'It doesn\'t look like you have permission to list peers IDs. '</span> + helpfulError);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (http.status !== <span class="hljs-number">200</span>) {
      cb([]);
    } <span class="hljs-keyword">else</span> {
      cb(<span class="hljs-built_in">JSON</span>.parse(http.responseText));
    }
  };
  http.send(<span class="hljs-literal">null</span>);
};

<span class="hljs-built_in">module</span>.exports = Peer;

},{<span class="hljs-string">"./dataconnection"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"./mediaconnection"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"./socket"</span>:<span class="hljs-number">7</span>,<span class="hljs-string">"./util"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"eventemitter3"</span>:<span class="hljs-number">9</span>}],<span class="hljs-number">7</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eventemitter3'</span>);

<span class="hljs-comment">/**
 * An abstraction on top of WebSockets and XHR streaming to provide fastest
 * possible connection for peers.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Socket</span>(<span class="hljs-params">secure, host, port, path, key</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Socket)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Socket(secure, host, port, path, key);

  EventEmitter.call(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Disconnected manually.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.disconnected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>._queue = [];

  <span class="hljs-keyword">var</span> httpProtocol = secure ? <span class="hljs-string">'https://'</span> : <span class="hljs-string">'http://'</span>;
  <span class="hljs-keyword">var</span> wsProtocol = secure ? <span class="hljs-string">'wss://'</span> : <span class="hljs-string">'ws://'</span>;
  <span class="hljs-keyword">this</span>._httpUrl = httpProtocol + host + <span class="hljs-string">':'</span> + port + path + key;
  <span class="hljs-keyword">this</span>._wsUrl = wsProtocol + host + <span class="hljs-string">':'</span> + port + path + <span class="hljs-string">'peerjs?key='</span> + key;
}

util.inherits(Socket, EventEmitter);


<span class="hljs-comment">/** Check in with ID or get one from server. */</span>
Socket.prototype.start = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, token</span>) </span>{
  <span class="hljs-keyword">this</span>.id = id;

  <span class="hljs-keyword">this</span>._httpUrl += <span class="hljs-string">'/'</span> + id + <span class="hljs-string">'/'</span> + token;
  <span class="hljs-keyword">this</span>._wsUrl += <span class="hljs-string">'&amp;id='</span> + id + <span class="hljs-string">'&amp;token='</span> + token;

  <span class="hljs-keyword">this</span>._startXhrStream();
  <span class="hljs-keyword">this</span>._startWebSocket();
}


<span class="hljs-comment">/** Start up websocket communications. */</span>
Socket.prototype._startWebSocket = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._socket) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">this</span>._socket = <span class="hljs-keyword">new</span> WebSocket(<span class="hljs-keyword">this</span>._wsUrl);

  <span class="hljs-keyword">this</span>._socket.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> data = <span class="hljs-built_in">JSON</span>.parse(event.data);
    } <span class="hljs-keyword">catch</span>(e) {
      util.log(<span class="hljs-string">'Invalid server message'</span>, event.data);
      <span class="hljs-keyword">return</span>;
    }
    self.emit(<span class="hljs-string">'message'</span>, data);
  };

  <span class="hljs-keyword">this</span>._socket.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
    util.log(<span class="hljs-string">'Socket closed.'</span>);
    self.disconnected = <span class="hljs-literal">true</span>;
    self.emit(<span class="hljs-string">'disconnected'</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Take care of the queue of connections if necessary and make sure Peer knows
socket is open.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._socket.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (self._timeout) {
      clearTimeout(self._timeout);
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        self._http.abort();
        self._http = <span class="hljs-literal">null</span>;
      }, <span class="hljs-number">5000</span>);
    }
    self._sendQueuedMessages();
    util.log(<span class="hljs-string">'Socket open'</span>);
  };
}

<span class="hljs-comment">/** Start XHR streaming. */</span>
Socket.prototype._startXhrStream = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>._http = <span class="hljs-keyword">new</span> XMLHttpRequest();
    <span class="hljs-keyword">this</span>._http._index = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>._http._streamIndex = n || <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>._http.open(<span class="hljs-string">'post'</span>, <span class="hljs-keyword">this</span>._httpUrl + <span class="hljs-string">'/id?i='</span> + <span class="hljs-keyword">this</span>._http._streamIndex, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">this</span>._http.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>If we get an error, likely something went wrong.
Stop streaming.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      clearTimeout(self._timeout);
      self.emit(<span class="hljs-string">'disconnected'</span>);
    }
    <span class="hljs-keyword">this</span>._http.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.readyState == <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">this</span>.old) {
        <span class="hljs-keyword">this</span>.old.abort();
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.old;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.readyState &gt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">this</span>.status === <span class="hljs-number">200</span> &amp;&amp; <span class="hljs-keyword">this</span>.responseText) {
        self._handleStream(<span class="hljs-keyword">this</span>);
      }
    };
    <span class="hljs-keyword">this</span>._http.send(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">this</span>._setHTTPTimeout();
  } <span class="hljs-keyword">catch</span>(e) {
    util.log(<span class="hljs-string">'XMLHttpRequest not available; defaulting to WebSockets'</span>);
  }
}


<span class="hljs-comment">/** Handles onreadystatechange response as a stream. */</span>
Socket.prototype._handleStream = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">http</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>3 and 4 are loading/done state. All others are not relevant.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> messages = http.responseText.split(<span class="hljs-string">'\n'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Check to see if anything needs to be processed on buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (http._buffer) {
    <span class="hljs-keyword">while</span> (http._buffer.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> index = http._buffer.shift();
      <span class="hljs-keyword">var</span> bufferedMessage = messages[index];
      <span class="hljs-keyword">try</span> {
        bufferedMessage = <span class="hljs-built_in">JSON</span>.parse(bufferedMessage);
      } <span class="hljs-keyword">catch</span>(e) {
        http._buffer.shift(index);
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'message'</span>, bufferedMessage);
    }
  }

  <span class="hljs-keyword">var</span> message = messages[http._index];
  <span class="hljs-keyword">if</span> (message) {
    http._index += <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Buffering–this message is incomplete and we’ll get to it next time.
This checks if the httpResponse ended in a <code>\n</code>, in which case the last
element of messages should be the empty string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (http._index === messages.length) {
      <span class="hljs-keyword">if</span> (!http._buffer) {
        http._buffer = [];
      }
      http._buffer.push(http._index - <span class="hljs-number">1</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">try</span> {
        message = <span class="hljs-built_in">JSON</span>.parse(message);
      } <span class="hljs-keyword">catch</span>(e) {
        util.log(<span class="hljs-string">'Invalid server message'</span>, message);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'message'</span>, message);
    }
  }
}

Socket.prototype._setHTTPTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>._timeout = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> old = self._http;
    <span class="hljs-keyword">if</span> (!self._wsOpen()) {
      self._startXhrStream(old._streamIndex + <span class="hljs-number">1</span>);
      self._http.old = old;
    } <span class="hljs-keyword">else</span> {
      old.abort();
    }
  }, <span class="hljs-number">25000</span>);
}

<span class="hljs-comment">/** Is the websocket currently open? */</span>
Socket.prototype._wsOpen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._socket &amp;&amp; <span class="hljs-keyword">this</span>._socket.readyState == <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/** Send queued messages. */</span>
Socket.prototype._sendQueuedMessages = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = <span class="hljs-keyword">this</span>._queue.length; i &lt; ii; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">this</span>.send(<span class="hljs-keyword">this</span>._queue[i]);
  }
}

<span class="hljs-comment">/** Exposed send for DC &amp; Peer. */</span>
Socket.prototype.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.disconnected) {
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>If we didn’t get an ID yet, we can’t yet send anything so we should queue
up these messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.id) {
    <span class="hljs-keyword">this</span>._queue.push(data);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (!data.type) {
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Invalid message'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> message = <span class="hljs-built_in">JSON</span>.stringify(data);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._wsOpen()) {
    <span class="hljs-keyword">this</span>._socket.send(message);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> http = <span class="hljs-keyword">new</span> XMLHttpRequest();
    <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>._httpUrl + <span class="hljs-string">'/'</span> + data.type.toLowerCase();
    http.open(<span class="hljs-string">'post'</span>, url, <span class="hljs-literal">true</span>);
    http.setRequestHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json'</span>);
    http.send(message);
  }
}

Socket.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.disconnected &amp;&amp; <span class="hljs-keyword">this</span>._wsOpen()) {
    <span class="hljs-keyword">this</span>._socket.close();
    <span class="hljs-keyword">this</span>.disconnected = <span class="hljs-literal">true</span>;
  }
}

<span class="hljs-built_in">module</span>.exports = Socket;

},{<span class="hljs-string">"./util"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"eventemitter3"</span>:<span class="hljs-number">9</span>}],<span class="hljs-number">8</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> defaultConfig = {<span class="hljs-string">'iceServers'</span>: [{ <span class="hljs-string">'url'</span>: <span class="hljs-string">'stun:stun.l.google.com:19302'</span> }]};
<span class="hljs-keyword">var</span> dataCount = <span class="hljs-number">1</span>;

<span class="hljs-keyword">var</span> BinaryPack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'js-binarypack'</span>);
<span class="hljs-keyword">var</span> RTCPeerConnection = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./adapter'</span>).RTCPeerConnection;

<span class="hljs-keyword">var</span> util = {
  noop: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{},

  CLOUD_HOST: <span class="hljs-string">'0.peerjs.com'</span>,
  CLOUD_PORT: <span class="hljs-number">9000</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Browsers that need chunking:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  chunkedBrowsers: {<span class="hljs-string">'Chrome'</span>: <span class="hljs-number">1</span>},
  chunkedMTU: <span class="hljs-number">16300</span>, <span class="hljs-comment">// The original 60000 bytes setting does not work when sending data from Firefox to Chrome, which is "cut off" after 16384 bytes and delivered individually.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Logging logic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  logLevel: <span class="hljs-number">0</span>,
  setLogLevel: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">level</span>) </span>{
    <span class="hljs-keyword">var</span> debugLevel = <span class="hljs-built_in">parseInt</span>(level, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(level, <span class="hljs-number">10</span>))) {
      util.logLevel = debugLevel;
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>If they are using truthy/falsy values for debug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      util.logLevel = level ? <span class="hljs-number">3</span> : <span class="hljs-number">0</span>;
    }
    util.log = util.warn = util.error = util.noop;
    <span class="hljs-keyword">if</span> (util.logLevel &gt; <span class="hljs-number">0</span>) {
      util.error = util._printWith(<span class="hljs-string">'ERROR'</span>);
    }
    <span class="hljs-keyword">if</span> (util.logLevel &gt; <span class="hljs-number">1</span>) {
      util.warn = util._printWith(<span class="hljs-string">'WARNING'</span>);
    }
    <span class="hljs-keyword">if</span> (util.logLevel &gt; <span class="hljs-number">2</span>) {
      util.log = util._print;
    }
  },
  setLogFunction: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>) </span>{
    <span class="hljs-keyword">if</span> (fn.constructor !== <span class="hljs-built_in">Function</span>) {
      util.warn(<span class="hljs-string">'The log function you passed in is not a function. Defaulting to regular logs.'</span>);
    } <span class="hljs-keyword">else</span> {
      util._print = fn;
    }
  },

  _printWith: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prefix</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> copy = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
      copy.unshift(prefix);
      util._print.apply(util, copy);
    };
  },
  _print: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> err = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> copy = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
    copy.unshift(<span class="hljs-string">'PeerJS: '</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = copy.length; i &lt; l; i++){
      <span class="hljs-keyword">if</span> (copy[i] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
        copy[i] = <span class="hljs-string">'('</span> + copy[i].name + <span class="hljs-string">') '</span> + copy[i].message;
        err = <span class="hljs-literal">true</span>;
      }
    }
    err ? <span class="hljs-built_in">console</span>.error.apply(<span class="hljs-built_in">console</span>, copy) : <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-built_in">console</span>, copy);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Returns browser-agnostic default config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  defaultConfig: defaultConfig,</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Returns the current browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  browser: (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.mozRTCPeerConnection) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'Firefox'</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.webkitRTCPeerConnection) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'Chrome'</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.RTCPeerConnection) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'Supported'</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'Unsupported'</span>;
    }
  })(),</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Lists which features are supported</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  supports: (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> RTCPeerConnection === <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-keyword">return</span> {};
    }

    <span class="hljs-keyword">var</span> data = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> audioVideo = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">var</span> binaryBlob = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> sctp = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> onnegotiationneeded = !!<span class="hljs-built_in">window</span>.webkitRTCPeerConnection;

    <span class="hljs-keyword">var</span> pc, dc;
    <span class="hljs-keyword">try</span> {
      pc = <span class="hljs-keyword">new</span> RTCPeerConnection(defaultConfig, {optional: [{RtpDataChannels: <span class="hljs-literal">true</span>}]});
    } <span class="hljs-keyword">catch</span> (e) {
      data = <span class="hljs-literal">false</span>;
      audioVideo = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">if</span> (data) {
      <span class="hljs-keyword">try</span> {
        dc = pc.createDataChannel(<span class="hljs-string">'_PEERJSTEST'</span>);
      } <span class="hljs-keyword">catch</span> (e) {
        data = <span class="hljs-literal">false</span>;
      }
    }

    <span class="hljs-keyword">if</span> (data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Binary test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">try</span> {
        dc.binaryType = <span class="hljs-string">'blob'</span>;
        binaryBlob = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">catch</span> (e) {
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Reliable test.
Unfortunately Chrome is a bit unreliable about whether or not they
support reliable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> reliablePC = <span class="hljs-keyword">new</span> RTCPeerConnection(defaultConfig, {});
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> reliableDC = reliablePC.createDataChannel(<span class="hljs-string">'_PEERJSRELIABLETEST'</span>, {});
        sctp = reliableDC.reliable;
      } <span class="hljs-keyword">catch</span> (e) {
      }
      reliablePC.close();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>FIXME: not really the best check…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (audioVideo) {
      audioVideo = !!pc.addStream;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>FIXME: this is not great because in theory it doesn’t work for
av-only browsers (?).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!onnegotiationneeded &amp;&amp; data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>sync default check.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> negotiationPC = <span class="hljs-keyword">new</span> RTCPeerConnection(defaultConfig, {optional: [{RtpDataChannels: <span class="hljs-literal">true</span>}]});
      negotiationPC.onnegotiationneeded = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        onnegotiationneeded = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>async check.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (util &amp;&amp; util.supports) {
          util.supports.onnegotiationneeded = <span class="hljs-literal">true</span>;
        }
      };
      negotiationPC.createDataChannel(<span class="hljs-string">'_PEERJSNEGOTIATIONTEST'</span>);

      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        negotiationPC.close();
      }, <span class="hljs-number">1000</span>);
    }

    <span class="hljs-keyword">if</span> (pc) {
      pc.close();
    }

    <span class="hljs-keyword">return</span> {
      audioVideo: audioVideo,
      data: data,
      binaryBlob: binaryBlob,
      binary: sctp, <span class="hljs-comment">// deprecated; sctp implies binary support.</span>
      reliable: sctp, <span class="hljs-comment">// deprecated; sctp implies reliable data.</span>
      sctp: sctp,
      onnegotiationneeded: onnegotiationneeded
    };
  }()),</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Ensure alphanumeric ids</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateId: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Allow empty ids</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> !id || <span class="hljs-regexp">/^[A-Za-z0-9_-]+(?:[ _-][A-Za-z0-9]+)*$/</span>.exec(id);
  },

  validateKey: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Allow empty keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> !key || <span class="hljs-regexp">/^[A-Za-z0-9_-]+(?:[ _-][A-Za-z0-9]+)*$/</span>.exec(key);
  },


  debug: <span class="hljs-literal">false</span>,

  inherits: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctor, superCtor</span>) </span>{
    ctor.super_ = superCtor;
    ctor.prototype = <span class="hljs-built_in">Object</span>.create(superCtor.prototype, {
      constructor: {
        value: ctor,
        enumerable: <span class="hljs-literal">false</span>,
        writable: <span class="hljs-literal">true</span>,
        configurable: <span class="hljs-literal">true</span>
      }
    });
  },
  extend: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dest, source</span>) </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> source) {
      <span class="hljs-keyword">if</span>(source.hasOwnProperty(key)) {
        dest[key] = source[key];
      }
    }
    <span class="hljs-keyword">return</span> dest;
  },
  pack: BinaryPack.pack,
  unpack: BinaryPack.unpack,

  log: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (util.debug) {
      <span class="hljs-keyword">var</span> err = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> copy = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
      copy.unshift(<span class="hljs-string">'PeerJS: '</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = copy.length; i &lt; l; i++){
        <span class="hljs-keyword">if</span> (copy[i] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
          copy[i] = <span class="hljs-string">'('</span> + copy[i].name + <span class="hljs-string">') '</span> + copy[i].message;
          err = <span class="hljs-literal">true</span>;
        }
      }
      err ? <span class="hljs-built_in">console</span>.error.apply(<span class="hljs-built_in">console</span>, copy) : <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-built_in">console</span>, copy);
    }
  },

  setZeroTimeout: (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">global</span>) </span>{
    <span class="hljs-keyword">var</span> timeouts = [];
    <span class="hljs-keyword">var</span> messageName = <span class="hljs-string">'zero-timeout-message'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Like setTimeout, but only takes a function argument.     There’s
no time argument (always zero) and no arguments (you have to
use a closure).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setZeroTimeoutPostMessage</span>(<span class="hljs-params">fn</span>) </span>{
      timeouts.push(fn);
      global.postMessage(messageName, <span class="hljs-string">'*'</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleMessage</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">if</span> (event.source == global &amp;&amp; event.data == messageName) {
        <span class="hljs-keyword">if</span> (event.stopPropagation) {
          event.stopPropagation();
        }
        <span class="hljs-keyword">if</span> (timeouts.length) {
          timeouts.shift()();
        }
      }
    }
    <span class="hljs-keyword">if</span> (global.addEventListener) {
      global.addEventListener(<span class="hljs-string">'message'</span>, handleMessage, <span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (global.attachEvent) {
      global.attachEvent(<span class="hljs-string">'onmessage'</span>, handleMessage);
    }
    <span class="hljs-keyword">return</span> setZeroTimeoutPostMessage;
  }(<span class="hljs-built_in">window</span>)),</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Binary stuff</p>

            </div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>chunks a blob.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  chunk: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bl</span>) </span>{
    <span class="hljs-keyword">var</span> chunks = [];
    <span class="hljs-keyword">var</span> size = bl.size;
    <span class="hljs-keyword">var</span> start = index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> total = <span class="hljs-built_in">Math</span>.ceil(size / util.chunkedMTU);
    <span class="hljs-keyword">while</span> (start &lt; size) {
      <span class="hljs-keyword">var</span> end = <span class="hljs-built_in">Math</span>.min(size, start + util.chunkedMTU);
      <span class="hljs-keyword">var</span> b = bl.slice(start, end);

      <span class="hljs-keyword">var</span> chunk = {
        __peerData: dataCount,
        n: index,
        data: b,
        total: total
      };

      chunks.push(chunk);

      start = end;
      index += <span class="hljs-number">1</span>;
    }
    dataCount += <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> chunks;
  },

  blobToArrayBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blob, cb</span>)</span>{
    <span class="hljs-keyword">var</span> fr = <span class="hljs-keyword">new</span> FileReader();
    fr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      cb(evt.target.result);
    };
    fr.readAsArrayBuffer(blob);
  },
  blobToBinaryString: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blob, cb</span>)</span>{
    <span class="hljs-keyword">var</span> fr = <span class="hljs-keyword">new</span> FileReader();
    fr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      cb(evt.target.result);
    };
    fr.readAsBinaryString(blob);
  },
  binaryStringToArrayBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">binary</span>) </span>{
    <span class="hljs-keyword">var</span> byteArray = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(binary.length);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; binary.length; i++) {
      byteArray[i] = binary.charCodeAt(i) &amp; <span class="hljs-number">0xff</span>;
    }
    <span class="hljs-keyword">return</span> byteArray.buffer;
  },
  randomToken: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
  isSecure: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> location.protocol === <span class="hljs-string">'https:'</span>;
  }
};

<span class="hljs-built_in">module</span>.exports = util;

},{<span class="hljs-string">"./adapter"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"js-binarypack"</span>:<span class="hljs-number">10</span>}],<span class="hljs-number">9</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-pi">'use strict'</span>;

<span class="hljs-comment">/**
 * Representation of a single EventEmitter function.
 *
 * @param {Function} fn Event handler to be called.
 * @param {Mixed} context Context for function execution.
 * @param {Boolean} once Only emit once
 * @api private
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EE</span>(<span class="hljs-params">fn, context, once</span>) </span>{
  <span class="hljs-keyword">this</span>.fn = fn;
  <span class="hljs-keyword">this</span>.context = context;
  <span class="hljs-keyword">this</span>.once = once || <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * Minimal EventEmitter interface that is molded against the Node.js
 * EventEmitter interface.
 *
 * @constructor
 * @api public
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EventEmitter</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">/* Nothing to set */</span> }

<span class="hljs-comment">/**
 * Holds the assigned EventEmitters by name.
 *
 * @type {Object}
 * @private
 */</span>
EventEmitter.prototype._events = <span class="hljs-literal">undefined</span>;

<span class="hljs-comment">/**
 * Return a list of assigned event listeners.
 *
 * @param {String} event The events that should be listed.
 * @returns {Array}
 * @api public
 */</span>
EventEmitter.prototype.listeners = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listeners</span>(<span class="hljs-params">event</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events || !<span class="hljs-keyword">this</span>._events[event]) <span class="hljs-keyword">return</span> [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">this</span>._events[event].length, ee = []; i &lt; l; i++) {
    ee.push(<span class="hljs-keyword">this</span>._events[event][i].fn);
  }

  <span class="hljs-keyword">return</span> ee;
};

<span class="hljs-comment">/**
 * Emit an event to all registered event listeners.
 *
 * @param {String} event The name of the event.
 * @returns {Boolean} Indication if we've emitted an event.
 * @api public
 */</span>
EventEmitter.prototype.emit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emit</span>(<span class="hljs-params">event, a1, a2, a3, a4, a5</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events || !<span class="hljs-keyword">this</span>._events[event]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">var</span> listeners = <span class="hljs-keyword">this</span>._events[event]
    , length = listeners.length
    , len = <span class="hljs-built_in">arguments</span>.length
    , ee = listeners[<span class="hljs-number">0</span>]
    , args
    , i, j;

  <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> === length) {
    <span class="hljs-keyword">if</span> (ee.once) <span class="hljs-keyword">this</span>.removeListener(event, ee.fn, <span class="hljs-literal">true</span>);

    <span class="hljs-keyword">switch</span> (len) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> ee.fn.call(ee.context), <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> ee.fn.call(ee.context, a1), <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">return</span> ee.fn.call(ee.context, a1, a2), <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span> ee.fn.call(ee.context, a1, a2, a3), <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-keyword">return</span> ee.fn.call(ee.context, a1, a2, a3, a4), <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: <span class="hljs-keyword">return</span> ee.fn.call(ee.context, a1, a2, a3, a4, a5), <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>, args = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(len -<span class="hljs-number">1</span>); i &lt; len; i++) {
      args[i - <span class="hljs-number">1</span>] = <span class="hljs-built_in">arguments</span>[i];
    }

    ee.fn.apply(ee.context, args);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; i++) {
      <span class="hljs-keyword">if</span> (listeners[i].once) <span class="hljs-keyword">this</span>.removeListener(event, listeners[i].fn, <span class="hljs-literal">true</span>);

      <span class="hljs-keyword">switch</span> (len) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: listeners[i].fn.call(listeners[i].context); <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: listeners[i].fn.call(listeners[i].context, a1); <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: listeners[i].fn.call(listeners[i].context, a1, a2); <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">if</span> (!args) <span class="hljs-keyword">for</span> (j = <span class="hljs-number">1</span>, args = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(len -<span class="hljs-number">1</span>); j &lt; len; j++) {
            args[j - <span class="hljs-number">1</span>] = <span class="hljs-built_in">arguments</span>[j];
          }

          listeners[i].fn.apply(listeners[i].context, args);
      }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

<span class="hljs-comment">/**
 * Register a new EventListener for the given event.
 *
 * @param {String} event Name of the event.
 * @param {Functon} fn Callback function.
 * @param {Mixed} context The context of the function.
 * @api public
 */</span>
EventEmitter.prototype.on = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">on</span>(<span class="hljs-params">event, fn, context</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">this</span>._events = {};
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events[event]) <span class="hljs-keyword">this</span>._events[event] = [];
  <span class="hljs-keyword">this</span>._events[event].push(<span class="hljs-keyword">new</span> EE( fn, context || <span class="hljs-keyword">this</span> ));

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Add an EventListener that's only called once.
 *
 * @param {String} event Name of the event.
 * @param {Function} fn Callback function.
 * @param {Mixed} context The context of the function.
 * @api public
 */</span>
EventEmitter.prototype.once = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">once</span>(<span class="hljs-params">event, fn, context</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">this</span>._events = {};
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events[event]) <span class="hljs-keyword">this</span>._events[event] = [];
  <span class="hljs-keyword">this</span>._events[event].push(<span class="hljs-keyword">new</span> EE(fn, context || <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span> ));

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Remove event listeners.
 *
 * @param {String} event The event we want to remove.
 * @param {Function} fn The listener that we need to find.
 * @param {Boolean} once Only remove once listeners.
 * @api public
 */</span>
EventEmitter.prototype.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeListener</span>(<span class="hljs-params">event, fn, once</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events || !<span class="hljs-keyword">this</span>._events[event]) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">var</span> listeners = <span class="hljs-keyword">this</span>._events[event]
    , events = [];

  <span class="hljs-keyword">if</span> (fn) <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, length = listeners.length; i &lt; length; i++) {
    <span class="hljs-keyword">if</span> (listeners[i].fn !== fn &amp;&amp; listeners[i].once !== once) {
      events.push(listeners[i]);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Reset the array, or remove it completely if we have no more listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (events.length) <span class="hljs-keyword">this</span>._events[event] = events;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>._events[event] = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Remove all listeners or only the listeners for the specified event.
 *
 * @param {String} event The event want to remove all listeners for.
 * @api public
 */</span>
EventEmitter.prototype.removeAllListeners = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeAllListeners</span>(<span class="hljs-params">event</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (event) <span class="hljs-keyword">this</span>._events[event] = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>._events = {};

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Alias methods names because people roll like that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventEmitter.prototype.off = EventEmitter.prototype.removeListener;
EventEmitter.prototype.addListener = EventEmitter.prototype.on;</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>This function doesn’t apply anymore.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventEmitter.prototype.setMaxListeners = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setMaxListeners</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Expose the module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventEmitter.EventEmitter = EventEmitter;
EventEmitter.EventEmitter2 = EventEmitter;
EventEmitter.EventEmitter3 = EventEmitter;

<span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> &amp;&amp; <span class="hljs-built_in">module</span>.exports) {
  <span class="hljs-built_in">module</span>.exports = EventEmitter;
}

},{}],<span class="hljs-number">10</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> BufferBuilder = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bufferbuilder'</span>).BufferBuilder;
<span class="hljs-keyword">var</span> binaryFeatures = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bufferbuilder'</span>).binaryFeatures;

<span class="hljs-keyword">var</span> BinaryPack = {
  unpack: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{
    <span class="hljs-keyword">var</span> unpacker = <span class="hljs-keyword">new</span> Unpacker(data);
    <span class="hljs-keyword">return</span> unpacker.unpack();
  },
  pack: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{
    <span class="hljs-keyword">var</span> packer = <span class="hljs-keyword">new</span> Packer();
    packer.pack(data);
    <span class="hljs-keyword">var</span> buffer = packer.getBuffer();
    <span class="hljs-keyword">return</span> buffer;
  }
};

<span class="hljs-built_in">module</span>.exports = BinaryPack;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Unpacker</span> (<span class="hljs-params">data</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Data is ArrayBuffer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.index = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>.dataBuffer = data;
  <span class="hljs-keyword">this</span>.dataView = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">this</span>.dataBuffer);
  <span class="hljs-keyword">this</span>.length = <span class="hljs-keyword">this</span>.dataBuffer.byteLength;
}

Unpacker.prototype.unpack = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">this</span>.unpack_uint8();
  <span class="hljs-keyword">if</span> (type &lt; <span class="hljs-number">0x80</span>){
    <span class="hljs-keyword">var</span> positive_fixnum = type;
    <span class="hljs-keyword">return</span> positive_fixnum;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((type ^ <span class="hljs-number">0xe0</span>) &lt; <span class="hljs-number">0x20</span>){
    <span class="hljs-keyword">var</span> negative_fixnum = (type ^ <span class="hljs-number">0xe0</span>) - <span class="hljs-number">0x20</span>;
    <span class="hljs-keyword">return</span> negative_fixnum;
  }
  <span class="hljs-keyword">var</span> size;
  <span class="hljs-keyword">if</span> ((size = type ^ <span class="hljs-number">0xa0</span>) &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_raw(size);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((size = type ^ <span class="hljs-number">0xb0</span>) &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_string(size);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((size = type ^ <span class="hljs-number">0x90</span>) &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_array(size);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((size = type ^ <span class="hljs-number">0x80</span>) &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_map(size);
  }
  <span class="hljs-keyword">switch</span>(type){
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xc0</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xc1</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xc2</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xc3</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xca</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_float();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcb</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_double();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcc</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_uint8();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcd</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_uint16();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xce</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_uint32();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcf</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_uint64();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd0</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_int8();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd1</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_int16();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd2</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_int32();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd3</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_int64();
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd4</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd5</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd6</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd7</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd8</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint16();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_string(size);
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xd9</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint32();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_string(size);
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xda</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint16();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_raw(size);
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xdb</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint32();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_raw(size);
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xdc</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint16();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_array(size);
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xdd</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint32();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_array(size);
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xde</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint16();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_map(size);
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xdf</span>:
      size = <span class="hljs-keyword">this</span>.unpack_uint32();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unpack_map(size);
  }
}

Unpacker.prototype.unpack_uint8 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> byte = <span class="hljs-keyword">this</span>.dataView[<span class="hljs-keyword">this</span>.index] &amp; <span class="hljs-number">0xff</span>;
  <span class="hljs-keyword">this</span>.index++;
  <span class="hljs-keyword">return</span> byte;
};

Unpacker.prototype.unpack_uint16 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">this</span>.read(<span class="hljs-number">2</span>);
  <span class="hljs-keyword">var</span> uint16 =
    ((bytes[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xff</span>) * <span class="hljs-number">256</span>) + (bytes[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xff</span>);
  <span class="hljs-keyword">this</span>.index += <span class="hljs-number">2</span>;
  <span class="hljs-keyword">return</span> uint16;
}

Unpacker.prototype.unpack_uint32 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">this</span>.read(<span class="hljs-number">4</span>);
  <span class="hljs-keyword">var</span> uint32 =
     ((bytes[<span class="hljs-number">0</span>]  * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">1</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">2</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">3</span>];
  <span class="hljs-keyword">this</span>.index += <span class="hljs-number">4</span>;
  <span class="hljs-keyword">return</span> uint32;
}

Unpacker.prototype.unpack_uint64 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">this</span>.read(<span class="hljs-number">8</span>);
  <span class="hljs-keyword">var</span> uint64 =
   ((((((bytes[<span class="hljs-number">0</span>]  * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">1</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">2</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">3</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">4</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">5</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">6</span>]) * <span class="hljs-number">256</span> +
       bytes[<span class="hljs-number">7</span>];
  <span class="hljs-keyword">this</span>.index += <span class="hljs-number">8</span>;
  <span class="hljs-keyword">return</span> uint64;
}


Unpacker.prototype.unpack_int8 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> uint8 = <span class="hljs-keyword">this</span>.unpack_uint8();
  <span class="hljs-keyword">return</span> (uint8 &lt; <span class="hljs-number">0x80</span> ) ? uint8 : uint8 - (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>);
};

Unpacker.prototype.unpack_int16 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> uint16 = <span class="hljs-keyword">this</span>.unpack_uint16();
  <span class="hljs-keyword">return</span> (uint16 &lt; <span class="hljs-number">0x8000</span> ) ? uint16 : uint16 - (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>);
}

Unpacker.prototype.unpack_int32 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> uint32 = <span class="hljs-keyword">this</span>.unpack_uint32();
  <span class="hljs-keyword">return</span> (uint32 &lt; <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">31</span>) ) ? uint32 :
    uint32 - <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>);
}

Unpacker.prototype.unpack_int64 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> uint64 = <span class="hljs-keyword">this</span>.unpack_uint64();
  <span class="hljs-keyword">return</span> (uint64 &lt; <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">63</span>) ) ? uint64 :
    uint64 - <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">64</span>);
}

Unpacker.prototype.unpack_raw = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">size</span>)</span>{
  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.length &lt; <span class="hljs-keyword">this</span>.index + size){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'BinaryPackFailure: index is out of range'</span>
      + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.index + <span class="hljs-string">' '</span> + size + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.length);
  }
  <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">this</span>.dataBuffer.slice(<span class="hljs-keyword">this</span>.index, <span class="hljs-keyword">this</span>.index + size);
  <span class="hljs-keyword">this</span>.index += size;</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>buf = util.bufferToString(buf);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">return</span> buf;
}

Unpacker.prototype.unpack_string = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">size</span>)</span>{
  <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">this</span>.read(size);
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, str = <span class="hljs-string">''</span>, c, code;
  <span class="hljs-keyword">while</span>(i &lt; size){
    c = bytes[i];
    <span class="hljs-keyword">if</span> ( c &lt; <span class="hljs-number">128</span>){
      str += <span class="hljs-built_in">String</span>.fromCharCode(c);
      i++;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((c ^ <span class="hljs-number">0xc0</span>) &lt; <span class="hljs-number">32</span>){
      code = ((c ^ <span class="hljs-number">0xc0</span>) &lt;&lt; <span class="hljs-number">6</span>) | (bytes[i+<span class="hljs-number">1</span>] &amp; <span class="hljs-number">63</span>);
      str += <span class="hljs-built_in">String</span>.fromCharCode(code);
      i += <span class="hljs-number">2</span>;
    } <span class="hljs-keyword">else</span> {
      code = ((c &amp; <span class="hljs-number">15</span>) &lt;&lt; <span class="hljs-number">12</span>) | ((bytes[i+<span class="hljs-number">1</span>] &amp; <span class="hljs-number">63</span>) &lt;&lt; <span class="hljs-number">6</span>) |
        (bytes[i+<span class="hljs-number">2</span>] &amp; <span class="hljs-number">63</span>);
      str += <span class="hljs-built_in">String</span>.fromCharCode(code);
      i += <span class="hljs-number">3</span>;
    }
  }
  <span class="hljs-keyword">this</span>.index += size;
  <span class="hljs-keyword">return</span> str;
}

Unpacker.prototype.unpack_array = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">size</span>)</span>{
  <span class="hljs-keyword">var</span> objects = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(size);
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; size ; i++){
    objects[i] = <span class="hljs-keyword">this</span>.unpack();
  }
  <span class="hljs-keyword">return</span> objects;
}

Unpacker.prototype.unpack_map = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">size</span>)</span>{
  <span class="hljs-keyword">var</span> map = {};
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; size ; i++){
    <span class="hljs-keyword">var</span> key  = <span class="hljs-keyword">this</span>.unpack();
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.unpack();
    map[key] = value;
  }
  <span class="hljs-keyword">return</span> map;
}

Unpacker.prototype.unpack_float = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> uint32 = <span class="hljs-keyword">this</span>.unpack_uint32();
  <span class="hljs-keyword">var</span> sign = uint32 &gt;&gt; <span class="hljs-number">31</span>;
  <span class="hljs-keyword">var</span> exp  = ((uint32 &gt;&gt; <span class="hljs-number">23</span>) &amp; <span class="hljs-number">0xff</span>) - <span class="hljs-number">127</span>;
  <span class="hljs-keyword">var</span> fraction = ( uint32 &amp; <span class="hljs-number">0x7fffff</span> ) | <span class="hljs-number">0x800000</span>;
  <span class="hljs-keyword">return</span> (sign == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>) *
    fraction * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, exp - <span class="hljs-number">23</span>);
}

Unpacker.prototype.unpack_double = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> h32 = <span class="hljs-keyword">this</span>.unpack_uint32();
  <span class="hljs-keyword">var</span> l32 = <span class="hljs-keyword">this</span>.unpack_uint32();
  <span class="hljs-keyword">var</span> sign = h32 &gt;&gt; <span class="hljs-number">31</span>;
  <span class="hljs-keyword">var</span> exp  = ((h32 &gt;&gt; <span class="hljs-number">20</span>) &amp; <span class="hljs-number">0x7ff</span>) - <span class="hljs-number">1023</span>;
  <span class="hljs-keyword">var</span> hfrac = ( h32 &amp; <span class="hljs-number">0xfffff</span> ) | <span class="hljs-number">0x100000</span>;
  <span class="hljs-keyword">var</span> frac = hfrac * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, exp - <span class="hljs-number">20</span>) +
    l32   * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, exp - <span class="hljs-number">52</span>);
  <span class="hljs-keyword">return</span> (sign == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>) * frac;
}

Unpacker.prototype.read = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">length</span>)</span>{
  <span class="hljs-keyword">var</span> j = <span class="hljs-keyword">this</span>.index;
  <span class="hljs-keyword">if</span> (j + length &lt;= <span class="hljs-keyword">this</span>.length) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dataView.subarray(j, j + length);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'BinaryPackFailure: read index out of range'</span>);
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Packer</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">this</span>.bufferBuilder = <span class="hljs-keyword">new</span> BufferBuilder();
}

Packer.prototype.getBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bufferBuilder.getBuffer();
}

Packer.prototype.pack = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)</span>{
  <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">typeof</span>(value);
  <span class="hljs-keyword">if</span> (type == <span class="hljs-string">'string'</span>){
    <span class="hljs-keyword">this</span>.pack_string(value);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-string">'number'</span>){
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.floor(value) === value){
      <span class="hljs-keyword">this</span>.pack_integer(value);
    } <span class="hljs-keyword">else</span>{
      <span class="hljs-keyword">this</span>.pack_double(value);
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-string">'boolean'</span>){
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">true</span>){
      <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xc3</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">false</span>){
      <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xc2</span>);
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-string">'undefined'</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xc0</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-string">'object'</span>){
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>){
      <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xc0</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> constructor = value.constructor;
      <span class="hljs-keyword">if</span> (constructor == <span class="hljs-built_in">Array</span>){
        <span class="hljs-keyword">this</span>.pack_array(value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructor == Blob || constructor == File) {
        <span class="hljs-keyword">this</span>.pack_bin(value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructor == <span class="hljs-built_in">ArrayBuffer</span>) {
        <span class="hljs-keyword">if</span>(binaryFeatures.useArrayBufferView) {
          <span class="hljs-keyword">this</span>.pack_bin(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(value));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>.pack_bin(value);
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'BYTES_PER_ELEMENT'</span> <span class="hljs-keyword">in</span> value){
        <span class="hljs-keyword">if</span>(binaryFeatures.useArrayBufferView) {
          <span class="hljs-keyword">this</span>.pack_bin(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(value.buffer));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>.pack_bin(value.buffer);
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructor == <span class="hljs-built_in">Object</span>){
        <span class="hljs-keyword">this</span>.pack_object(value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructor == <span class="hljs-built_in">Date</span>){
        <span class="hljs-keyword">this</span>.pack_string(value.toString());
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value.toBinaryPack == <span class="hljs-string">'function'</span>){
        <span class="hljs-keyword">this</span>.bufferBuilder.append(value.toBinaryPack());
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Type "'</span> + constructor.toString() + <span class="hljs-string">'" not yet supported'</span>);
      }
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Type "'</span> + type + <span class="hljs-string">'" not yet supported'</span>);
  }
  <span class="hljs-keyword">this</span>.bufferBuilder.flush();
}


Packer.prototype.pack_bin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blob</span>)</span>{
  <span class="hljs-keyword">var</span> length = blob.length || blob.byteLength || blob.size;
  <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">this</span>.pack_uint8(<span class="hljs-number">0xa0</span> + length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xda</span>) ;
    <span class="hljs-keyword">this</span>.pack_uint16(length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffffffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xdb</span>);
    <span class="hljs-keyword">this</span>.pack_uint32(length);
  } <span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid length'</span>);
  }
  <span class="hljs-keyword">this</span>.bufferBuilder.append(blob);
}

Packer.prototype.pack_string = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>)</span>{
  <span class="hljs-keyword">var</span> length = utf8Length(str);

  <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">this</span>.pack_uint8(<span class="hljs-number">0xb0</span> + length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xd8</span>) ;
    <span class="hljs-keyword">this</span>.pack_uint16(length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffffffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xd9</span>);
    <span class="hljs-keyword">this</span>.pack_uint32(length);
  } <span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid length'</span>);
  }
  <span class="hljs-keyword">this</span>.bufferBuilder.append(str);
}

Packer.prototype.pack_array = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ary</span>)</span>{
  <span class="hljs-keyword">var</span> length = ary.length;
  <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">this</span>.pack_uint8(<span class="hljs-number">0x90</span> + length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xdc</span>)
    <span class="hljs-keyword">this</span>.pack_uint16(length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffffffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xdd</span>);
    <span class="hljs-keyword">this</span>.pack_uint32(length);
  } <span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid length'</span>);
  }
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; length ; i++){
    <span class="hljs-keyword">this</span>.pack(ary[i]);
  }
}

Packer.prototype.pack_integer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">if</span> ( -<span class="hljs-number">0x20</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0x7f</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(num &amp; <span class="hljs-number">0xff</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0x00</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0xff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xcc</span>);
    <span class="hljs-keyword">this</span>.pack_uint8(num);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (-<span class="hljs-number">0x80</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0x7f</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xd0</span>);
    <span class="hljs-keyword">this</span>.pack_int8(num);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-number">0x0000</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0xffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xcd</span>);
    <span class="hljs-keyword">this</span>.pack_uint16(num);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (-<span class="hljs-number">0x8000</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0x7fff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xd1</span>);
    <span class="hljs-keyword">this</span>.pack_int16(num);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-number">0x00000000</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0xffffffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xce</span>);
    <span class="hljs-keyword">this</span>.pack_uint32(num);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (-<span class="hljs-number">0x80000000</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0x7fffffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xd2</span>);
    <span class="hljs-keyword">this</span>.pack_int32(num);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (-<span class="hljs-number">0x8000000000000000</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0x7FFFFFFFFFFFFFFF</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xd3</span>);
    <span class="hljs-keyword">this</span>.pack_int64(num);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0x0000000000000000</span> &lt;= num &amp;&amp; num &lt;= <span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xcf</span>);
    <span class="hljs-keyword">this</span>.pack_uint64(num);
  } <span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid integer'</span>);
  }
}

Packer.prototype.pack_double = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">var</span> sign = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (num &lt; <span class="hljs-number">0</span>){
    sign = <span class="hljs-number">1</span>;
    num = -num;
  }
  <span class="hljs-keyword">var</span> exp  = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.log(num) / <span class="hljs-built_in">Math</span>.LN2);
  <span class="hljs-keyword">var</span> frac0 = num / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, exp) - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">var</span> frac1 = <span class="hljs-built_in">Math</span>.floor(frac0 * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">52</span>));
  <span class="hljs-keyword">var</span> b32   = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>);
  <span class="hljs-keyword">var</span> h32 = (sign &lt;&lt; <span class="hljs-number">31</span>) | ((exp+<span class="hljs-number">1023</span>) &lt;&lt; <span class="hljs-number">20</span>) |
      (frac1 / b32) &amp; <span class="hljs-number">0x0fffff</span>;
  <span class="hljs-keyword">var</span> l32 = frac1 % b32;
  <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xcb</span>);
  <span class="hljs-keyword">this</span>.pack_int32(h32);
  <span class="hljs-keyword">this</span>.pack_int32(l32);
}

Packer.prototype.pack_object = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)</span>{
  <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(obj);
  <span class="hljs-keyword">var</span> length = keys.length;
  <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0x0f</span>){
    <span class="hljs-keyword">this</span>.pack_uint8(<span class="hljs-number">0x80</span> + length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xde</span>);
    <span class="hljs-keyword">this</span>.pack_uint16(length);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &lt;= <span class="hljs-number">0xffffffff</span>){
    <span class="hljs-keyword">this</span>.bufferBuilder.append(<span class="hljs-number">0xdf</span>);
    <span class="hljs-keyword">this</span>.pack_uint32(length);
  } <span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid length'</span>);
  }
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> obj){
    <span class="hljs-keyword">if</span> (obj.hasOwnProperty(prop)){
      <span class="hljs-keyword">this</span>.pack(prop);
      <span class="hljs-keyword">this</span>.pack(obj[prop]);
    }
  }
}

Packer.prototype.pack_uint8 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">this</span>.bufferBuilder.append(num);
}

Packer.prototype.pack_uint16 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">this</span>.bufferBuilder.append(num &gt;&gt; <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append(num &amp; <span class="hljs-number">0xff</span>);
}

Packer.prototype.pack_uint32 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">var</span> n = num &amp; <span class="hljs-number">0xffffffff</span>;
  <span class="hljs-keyword">this</span>.bufferBuilder.append((n &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((n &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt;&gt; <span class="hljs-number">16</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((n &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt;&gt;  <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((n &amp; <span class="hljs-number">0x000000ff</span>));
}

Packer.prototype.pack_uint64 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">var</span> high = num / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>);
  <span class="hljs-keyword">var</span> low  = num % <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt;&gt; <span class="hljs-number">16</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt;&gt;  <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0x000000ff</span>));
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt;&gt; <span class="hljs-number">16</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt;&gt;  <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0x000000ff</span>));
}

Packer.prototype.pack_int8 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">this</span>.bufferBuilder.append(num &amp; <span class="hljs-number">0xff</span>);
}

Packer.prototype.pack_int16 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">this</span>.bufferBuilder.append((num &amp; <span class="hljs-number">0xff00</span>) &gt;&gt; <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append(num &amp; <span class="hljs-number">0xff</span>);
}

Packer.prototype.pack_int32 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">this</span>.bufferBuilder.append((num &gt;&gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((num &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt;&gt; <span class="hljs-number">16</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((num &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt;&gt; <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((num &amp; <span class="hljs-number">0x000000ff</span>));
}

Packer.prototype.pack_int64 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>)</span>{
  <span class="hljs-keyword">var</span> high = <span class="hljs-built_in">Math</span>.floor(num / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>));
  <span class="hljs-keyword">var</span> low  = num % <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt;&gt; <span class="hljs-number">16</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt;&gt;  <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((high &amp; <span class="hljs-number">0x000000ff</span>));
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;&gt; <span class="hljs-number">24</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt;&gt; <span class="hljs-number">16</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt;&gt;  <span class="hljs-number">8</span>);
  <span class="hljs-keyword">this</span>.bufferBuilder.append((low  &amp; <span class="hljs-number">0x000000ff</span>));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_utf8Replace</span>(<span class="hljs-params">m</span>)</span>{
  <span class="hljs-keyword">var</span> code = m.charCodeAt(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">if</span>(code &lt;= <span class="hljs-number">0x7ff</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'00'</span>;
  <span class="hljs-keyword">if</span>(code &lt;= <span class="hljs-number">0xffff</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'000'</span>;
  <span class="hljs-keyword">if</span>(code &lt;= <span class="hljs-number">0x1fffff</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'0000'</span>;
  <span class="hljs-keyword">if</span>(code &lt;= <span class="hljs-number">0x3ffffff</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'00000'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">'000000'</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">utf8Length</span>(<span class="hljs-params">str</span>)</span>{
  <span class="hljs-keyword">if</span> (str.length &gt; <span class="hljs-number">600</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Blob method faster for large strings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Blob([str])).size;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/[^\u0000-\u007F]/g</span>, _utf8Replace).length;
  }
}

},{<span class="hljs-string">"./bufferbuilder"</span>:<span class="hljs-number">11</span>}],<span class="hljs-number">11</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> binaryFeatures = {};
binaryFeatures.useBlobBuilder = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">new</span> Blob([]);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
})();

binaryFeatures.useArrayBufferView = !binaryFeatures.useBlobBuilder &amp;&amp; (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Blob([<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>([])])).size === <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
})();

<span class="hljs-built_in">module</span>.exports.binaryFeatures = binaryFeatures;
<span class="hljs-keyword">var</span> BlobBuilder = <span class="hljs-built_in">module</span>.exports.BlobBuilder;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> != <span class="hljs-string">'undefined'</span>) {
  BlobBuilder = <span class="hljs-built_in">module</span>.exports.BlobBuilder = <span class="hljs-built_in">window</span>.WebKitBlobBuilder ||
    <span class="hljs-built_in">window</span>.MozBlobBuilder || <span class="hljs-built_in">window</span>.MSBlobBuilder || <span class="hljs-built_in">window</span>.BlobBuilder;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BufferBuilder</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">this</span>._pieces = [];
  <span class="hljs-keyword">this</span>._parts = [];
}

BufferBuilder.prototype.append = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'number'</span>) {
    <span class="hljs-keyword">this</span>._pieces.push(data);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.flush();
    <span class="hljs-keyword">this</span>._parts.push(data);
  }
};

BufferBuilder.prototype.flush = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._pieces.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-keyword">this</span>._pieces);
    <span class="hljs-keyword">if</span>(!binaryFeatures.useArrayBufferView) {
      buf = buf.buffer;
    }
    <span class="hljs-keyword">this</span>._parts.push(buf);
    <span class="hljs-keyword">this</span>._pieces = [];
  }
};

BufferBuilder.prototype.getBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.flush();
  <span class="hljs-keyword">if</span>(binaryFeatures.useBlobBuilder) {
    <span class="hljs-keyword">var</span> builder = <span class="hljs-keyword">new</span> BlobBuilder();
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = <span class="hljs-keyword">this</span>._parts.length; i &lt; ii; i++) {
      builder.append(<span class="hljs-keyword">this</span>._parts[i]);
    }
    <span class="hljs-keyword">return</span> builder.getBlob();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Blob(<span class="hljs-keyword">this</span>._parts);
  }
};

<span class="hljs-built_in">module</span>.exports.BufferBuilder = BufferBuilder;

},{}],<span class="hljs-number">12</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);

<span class="hljs-comment">/**
 * Reliable transfer for Chrome Canary DataChannel impl.
 * Author: @michellebu
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Reliable</span>(<span class="hljs-params">dc, debug</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Reliable)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Reliable(dc);
  <span class="hljs-keyword">this</span>._dc = dc;

  util.debug = debug;</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Messages sent/received so far.
id: { ack: n, chunks: […] }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._outgoing = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>id: { ack: [‘ack’, id, n], chunks: […] }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._incoming = {};
  <span class="hljs-keyword">this</span>._received = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Window size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._window = <span class="hljs-number">1000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>MTU.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._mtu = <span class="hljs-number">500</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Interval for setInterval. In ms.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._interval = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Messages sent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._count = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Outgoing message queue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._queue = [];

  <span class="hljs-keyword">this</span>._setupDC();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Send a message reliably.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Determine if chunking is necessary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> bl = util.pack(msg);
  <span class="hljs-keyword">if</span> (bl.size &lt; <span class="hljs-keyword">this</span>._mtu) {
    <span class="hljs-keyword">this</span>._handleSend([<span class="hljs-string">'no'</span>, bl]);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">this</span>._outgoing[<span class="hljs-keyword">this</span>._count] = {
    ack: <span class="hljs-number">0</span>,
    chunks: <span class="hljs-keyword">this</span>._chunk(bl)
  };

  <span class="hljs-keyword">if</span> (util.debug) {
    <span class="hljs-keyword">this</span>._outgoing[<span class="hljs-keyword">this</span>._count].timer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Send prelim window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>._sendWindowedChunks(<span class="hljs-keyword">this</span>._count);
  <span class="hljs-keyword">this</span>._count += <span class="hljs-number">1</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Set up interval for processing queue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._setupInterval = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>TODO: fail gracefully.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>._timeout = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>FIXME: String stuff makes things terribly async.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> msg = self._queue.shift();
    <span class="hljs-keyword">if</span> (msg._multiple) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = msg.length; i &lt; ii; i += <span class="hljs-number">1</span>) {
        self._intervalSend(msg[i]);
      }
    } <span class="hljs-keyword">else</span> {
      self._intervalSend(msg);
    }
  }, <span class="hljs-keyword">this</span>._interval);
};

Reliable.prototype._intervalSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  msg = util.pack(msg);
  util.blobToBinaryString(msg, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{
    self._dc.send(str);
  });
  <span class="hljs-keyword">if</span> (self._queue.length === <span class="hljs-number">0</span>) {
    clearTimeout(self._timeout);
    self._timeout = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>self._processAcks();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Go through ACKs to send missing pieces.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._processAcks = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._outgoing) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._outgoing.hasOwnProperty(id)) {
      <span class="hljs-keyword">this</span>._sendWindowedChunks(id);
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Handle sending a message.
FIXME: Don’t wait for interval time for all messages…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._handleSend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-keyword">var</span> push = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = <span class="hljs-keyword">this</span>._queue.length; i &lt; ii; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">this</span>._queue[i];
    <span class="hljs-keyword">if</span> (item === msg) {
      push = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item._multiple &amp;&amp; item.indexOf(msg) !== -<span class="hljs-number">1</span>) {
      push = <span class="hljs-literal">false</span>;
    }
  }
  <span class="hljs-keyword">if</span> (push) {
    <span class="hljs-keyword">this</span>._queue.push(msg);
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._timeout) {
      <span class="hljs-keyword">this</span>._setupInterval();
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Set up DataChannel handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._setupDC = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Handle various message types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>._dc.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">var</span> msg = e.data;
    <span class="hljs-keyword">var</span> datatype = msg.constructor;</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>FIXME: msg is String until binary is supported.
Once that happens, this will have to be smarter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (datatype === <span class="hljs-built_in">String</span>) {
      <span class="hljs-keyword">var</span> ab = util.binaryStringToArrayBuffer(msg);
      msg = util.unpack(ab);
      self._handleMessage(msg);
    }
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Handles an incoming message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._handleMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-keyword">var</span> id = msg[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">var</span> idata = <span class="hljs-keyword">this</span>._incoming[id];
  <span class="hljs-keyword">var</span> odata = <span class="hljs-keyword">this</span>._outgoing[id];
  <span class="hljs-keyword">var</span> data;
  <span class="hljs-keyword">switch</span> (msg[<span class="hljs-number">0</span>]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>No chunking was done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">case</span> <span class="hljs-string">'no'</span>:
      <span class="hljs-keyword">var</span> message = id;
      <span class="hljs-keyword">if</span> (!!message) {
        <span class="hljs-keyword">this</span>.onmessage(util.unpack(message));
      }
      <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Reached the end of the message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">case</span> <span class="hljs-string">'end'</span>:
      data = idata;</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>In case end comes first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._received[id] = msg[<span class="hljs-number">2</span>];

      <span class="hljs-keyword">if</span> (!data) {
        <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-keyword">this</span>._ack(id);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ack'</span>:
      data = odata;
      <span class="hljs-keyword">if</span> (!!data) {
        <span class="hljs-keyword">var</span> ack = msg[<span class="hljs-number">2</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Take the larger ACK, for out of order messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        data.ack = <span class="hljs-built_in">Math</span>.max(ack, data.ack);</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Clean up when all chunks are ACKed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (data.ack &gt;= data.chunks.length) {
          util.log(<span class="hljs-string">'Time: '</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() - data.timer);
          <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._outgoing[id];
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>._processAcks();
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>If !data, just ignore.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Received a chunk of data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">case</span> <span class="hljs-string">'chunk'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Create a new entry if none exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      data = idata;
      <span class="hljs-keyword">if</span> (!data) {
        <span class="hljs-keyword">var</span> end = <span class="hljs-keyword">this</span>._received[id];
        <span class="hljs-keyword">if</span> (end === <span class="hljs-literal">true</span>) {
          <span class="hljs-keyword">break</span>;
        }
        data = {
          ack: [<span class="hljs-string">'ack'</span>, id, <span class="hljs-number">0</span>],
          chunks: []
        };
        <span class="hljs-keyword">this</span>._incoming[id] = data;
      }

      <span class="hljs-keyword">var</span> n = msg[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">var</span> chunk = msg[<span class="hljs-number">3</span>];
      data.chunks[n] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(chunk);</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>If we get the chunk we’re looking for, ACK for next missing.
Otherwise, ACK the same N again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (n === data.ack[<span class="hljs-number">2</span>]) {
        <span class="hljs-keyword">this</span>._calculateNextAck(id);
      }
      <span class="hljs-keyword">this</span>._ack(id);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Shouldn’t happen, but would make sense for message to just go
through as is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._handleSend(msg);
      <span class="hljs-keyword">break</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Chunks BL into smaller messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._chunk = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bl</span>) </span>{
  <span class="hljs-keyword">var</span> chunks = [];
  <span class="hljs-keyword">var</span> size = bl.size;
  <span class="hljs-keyword">var</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (start &lt; size) {
    <span class="hljs-keyword">var</span> end = <span class="hljs-built_in">Math</span>.min(size, start + <span class="hljs-keyword">this</span>._mtu);
    <span class="hljs-keyword">var</span> b = bl.slice(start, end);
    <span class="hljs-keyword">var</span> chunk = {
      payload: b
    }
    chunks.push(chunk);
    start = end;
  }
  util.log(<span class="hljs-string">'Created'</span>, chunks.length, <span class="hljs-string">'chunks.'</span>);
  <span class="hljs-keyword">return</span> chunks;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Sends ACK N, expecting Nth blob chunk for message ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._ack = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">var</span> ack = <span class="hljs-keyword">this</span>._incoming[id].ack;</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>if ack is the end value, then call _complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._received[id] === ack[<span class="hljs-number">2</span>]) {
    <span class="hljs-keyword">this</span>._complete(id);
    <span class="hljs-keyword">this</span>._received[id] = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">this</span>._handleSend(ack);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Calculates the next ACK number, given chunks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._calculateNextAck = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>._incoming[id];
  <span class="hljs-keyword">var</span> chunks = data.chunks;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, ii = chunks.length; i &lt; ii; i += <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>This chunk is missing!!! Better ACK for it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (chunks[i] === <span class="hljs-literal">undefined</span>) {
      data.ack[<span class="hljs-number">2</span>] = i;
      <span class="hljs-keyword">return</span>;
    }
  }
  data.ack[<span class="hljs-number">2</span>] = chunks.length;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Sends the next window of chunks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._sendWindowedChunks = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
  util.log(<span class="hljs-string">'sendWindowedChunks for: '</span>, id);
  <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>._outgoing[id];
  <span class="hljs-keyword">var</span> ch = data.chunks;
  <span class="hljs-keyword">var</span> chunks = [];
  <span class="hljs-keyword">var</span> limit = <span class="hljs-built_in">Math</span>.min(data.ack + <span class="hljs-keyword">this</span>._window, ch.length);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = data.ack; i &lt; limit; i += <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (!ch[i].sent || i === data.ack) {
      ch[i].sent = <span class="hljs-literal">true</span>;
      chunks.push([<span class="hljs-string">'chunk'</span>, id, i, ch[i].payload]);
    }
  }
  <span class="hljs-keyword">if</span> (data.ack + <span class="hljs-keyword">this</span>._window &gt;= ch.length) {
    chunks.push([<span class="hljs-string">'end'</span>, id, ch.length])
  }
  chunks._multiple = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">this</span>._handleSend(chunks);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Puts together a message from chunks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype._complete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
  util.log(<span class="hljs-string">'Completed called for'</span>, id);
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> chunks = <span class="hljs-keyword">this</span>._incoming[id].chunks;
  <span class="hljs-keyword">var</span> bl = <span class="hljs-keyword">new</span> Blob(chunks);
  util.blobToArrayBuffer(bl, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ab</span>) </span>{
    self.onmessage(util.unpack(ab));
  });
  <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._incoming[id];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Ups bandwidth limit on SDP. Meant to be called during offer/answer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.higherBandwidthSDP = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sdp</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>AS stands for Application-Specific Maximum.
Bandwidth number is in kilobits / sec.
See RFC for more info: <a href="http://www.ietf.org/rfc/rfc2327.txt">http://www.ietf.org/rfc/rfc2327.txt</a></p>

            </div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Chrome 31+ doesn’t want us munging the SDP, so we’ll let them have their
way.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> version = navigator.appVersion.match(<span class="hljs-regexp">/Chrome\/(.*?) /</span>);
  <span class="hljs-keyword">if</span> (version) {
    version = <span class="hljs-built_in">parseInt</span>(version[<span class="hljs-number">1</span>].split(<span class="hljs-string">'.'</span>).shift());
    <span class="hljs-keyword">if</span> (version &lt; <span class="hljs-number">31</span>) {
      <span class="hljs-keyword">var</span> parts = sdp.split(<span class="hljs-string">'b=AS:30'</span>);
      <span class="hljs-keyword">var</span> replace = <span class="hljs-string">'b=AS:102400'</span>; <span class="hljs-comment">// 100 Mbps</span>
      <span class="hljs-keyword">if</span> (parts.length &gt; <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> parts[<span class="hljs-number">0</span>] + replace + parts[<span class="hljs-number">1</span>];
      }
    }
  }

  <span class="hljs-keyword">return</span> sdp;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Overwritten, typically.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Reliable.prototype.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{};

<span class="hljs-built_in">module</span>.exports.Reliable = Reliable;

},{<span class="hljs-string">"./util"</span>:<span class="hljs-number">13</span>}],<span class="hljs-number">13</span>:[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">require,module,exports</span>)</span>{
<span class="hljs-keyword">var</span> BinaryPack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'js-binarypack'</span>);

<span class="hljs-keyword">var</span> util = {
  debug: <span class="hljs-literal">false</span>,
  
  inherits: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctor, superCtor</span>) </span>{
    ctor.super_ = superCtor;
    ctor.prototype = <span class="hljs-built_in">Object</span>.create(superCtor.prototype, {
      constructor: {
        value: ctor,
        enumerable: <span class="hljs-literal">false</span>,
        writable: <span class="hljs-literal">true</span>,
        configurable: <span class="hljs-literal">true</span>
      }
    });
  },
  extend: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dest, source</span>) </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> source) {
      <span class="hljs-keyword">if</span>(source.hasOwnProperty(key)) {
        dest[key] = source[key];
      }
    }
    <span class="hljs-keyword">return</span> dest;
  },
  pack: BinaryPack.pack,
  unpack: BinaryPack.unpack,
  
  log: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (util.debug) {
      <span class="hljs-keyword">var</span> copy = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
        copy[i] = <span class="hljs-built_in">arguments</span>[i];
      }
      copy.unshift(<span class="hljs-string">'Reliable: '</span>);
      <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-built_in">console</span>, copy);
    }
  },

  setZeroTimeout: (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">global</span>) </span>{
    <span class="hljs-keyword">var</span> timeouts = [];
    <span class="hljs-keyword">var</span> messageName = <span class="hljs-string">'zero-timeout-message'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Like setTimeout, but only takes a function argument.     There’s
no time argument (always zero) and no arguments (you have to
use a closure).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setZeroTimeoutPostMessage</span>(<span class="hljs-params">fn</span>) </span>{
      timeouts.push(fn);
      global.postMessage(messageName, <span class="hljs-string">'*'</span>);
    }		

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleMessage</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">if</span> (event.source == global &amp;&amp; event.data == messageName) {
        <span class="hljs-keyword">if</span> (event.stopPropagation) {
          event.stopPropagation();
        }
        <span class="hljs-keyword">if</span> (timeouts.length) {
          timeouts.shift()();
        }
      }
    }
    <span class="hljs-keyword">if</span> (global.addEventListener) {
      global.addEventListener(<span class="hljs-string">'message'</span>, handleMessage, <span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (global.attachEvent) {
      global.attachEvent(<span class="hljs-string">'onmessage'</span>, handleMessage);
    }
    <span class="hljs-keyword">return</span> setZeroTimeoutPostMessage;
  }(<span class="hljs-keyword">this</span>)),
  
  blobToArrayBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blob, cb</span>)</span>{
    <span class="hljs-keyword">var</span> fr = <span class="hljs-keyword">new</span> FileReader();
    fr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      cb(evt.target.result);
    };
    fr.readAsArrayBuffer(blob);
  },
  blobToBinaryString: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blob, cb</span>)</span>{
    <span class="hljs-keyword">var</span> fr = <span class="hljs-keyword">new</span> FileReader();
    fr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      cb(evt.target.result);
    };
    fr.readAsBinaryString(blob);
  },
  binaryStringToArrayBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">binary</span>) </span>{
    <span class="hljs-keyword">var</span> byteArray = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(binary.length);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; binary.length; i++) {
      byteArray[i] = binary.charCodeAt(i) &amp; <span class="hljs-number">0xff</span>;
    }
    <span class="hljs-keyword">return</span> byteArray.buffer;
  },
  randomToken: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>);
  }
};

<span class="hljs-built_in">module</span>.exports = util;

},{<span class="hljs-string">"js-binarypack"</span>:<span class="hljs-number">10</span>}]},{},[<span class="hljs-number">3</span>]);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
